{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block extrastyle %}
{{ block.super }}
<!-- Bootstrap 5.3 CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
<!-- Bootstrap Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
<style>
    /* 1. –°—Ç–∏–ª—å —Ç–∞–±–ª–∏—Ü—ã –≤ —Å–≤–µ—Ç–ª–æ–π —Ç–µ–º–µ */
    .custom-table-container {
        background: #ffffff;
        border: 1px solid #e0e0e0;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }

    .table {
        margin-bottom: 0;
        color: #333333;
    }

    .table thead th {
        background: #f8f9fa;
        border-bottom: 2px solid #eeeeee;
        color: #666666;
        text-transform: uppercase;
        font-size: 0.7rem;
        letter-spacing: 0.5px;
        padding: 14px 16px;
        font-weight: 700;
    }

    .table tbody td {
        padding: 16px;
        vertical-align: middle;
        border-bottom: 1px solid #f0f0f0;
        font-size: 0.85rem;
        background: #ffffff;
    }

    .table tbody tr:hover td {
        background-color: #fcfdfd !important;
    }

    /* 2. Status Badges */
    .status-badge {
        padding: 4px 12px;
        border-radius: 50px;
        font-size: 0.72rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }
    .status-true { 
        background: #e8f5e9; 
        color: #2e7d32; 
        border: 1px solid #c8e6c9; 
    }
    .status-false { 
        background: #ffebee; 
        color: #c62828; 
        border: 1px solid #ffcdd2; 
    }

    /* 3. –ö–Ω–æ–ø–∫–∞ VK */
    .btn-vk {
        background: #f0f4ff;
        border: 1px solid #d0d7f1;
        color: #4c66a4;
        font-size: 0.75rem;
        font-weight: 600;
        transition: all 0.2s ease-in-out;
        border-radius: 6px;
    }
    .btn-vk:hover {
        background: #4c66a4;
        color: white;
        border-color: #4c66a4;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(76, 102, 164, 0.2);
    }

    /* 4. –ù–∞–≤–∏–≥–∞—Ü–∏—è (Breadcrumbs) */
    .breadcrumbs {
        background: #ffffff;
        border-bottom: 1px solid #e0e0e0;
        padding: 12px 24px;
        font-size: 13px;
        color: #666;
    }

    .breadcrumbs a {
        color: #28a745;
        text-decoration: none;
    }

    .breadcrumbs a:hover {
        text-decoration: underline;
    }

    /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Ç–∏–ª–∏—Ç—ã */
    .text-main-black { color: #212529 !important; }
    .text-main-muted { color: #888888 !important; }

    /* ‚ïê‚ïê‚ïê Fix: Bootstrap vs Django Admin Sidebar ‚ïê‚ïê‚ïê */
    #container, #header, #nav-sidebar,
    #container *, #header *, #nav-sidebar * {
        box-sizing: content-box !important;
    }
    #nav-sidebar {
        position: sticky !important;
        top: 0 !important;
        max-height: 100vh !important;
        overflow-x: hidden !important;
        overflow-y: auto !important;
        width: 275px !important;
        flex-shrink: 0 !important;
    }
    #nav-sidebar ul {
        padding-left: 0;
        margin-bottom: 0;
        list-style: none;
    }
    #nav-sidebar li {
        list-style: none;
    }
    #nav-sidebar, #nav-sidebar * {
        scroll-behavior: auto !important;
    }
    #content, #content * {
        box-sizing: border-box !important;
    }

    /* ‚îÄ‚îÄ‚îÄ Period Selector (compact) ‚îÄ‚îÄ‚îÄ */
    .period-selector-sm {
        display: inline-flex;
        gap: 0;
        background: #ffffff;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 1px 2px rgba(0,0,0,0.04);
    }
    .period-selector-sm a {
        padding: 5px 12px;
        font-size: 0.72rem;
        font-weight: 600;
        color: #555;
        text-decoration: none;
        border-right: 1px solid #eee;
        transition: all 0.15s;
        white-space: nowrap;
    }
    .period-selector-sm a:last-child { border-right: none; }
    .period-selector-sm a:hover {
        background: #f0faf1;
        color: #28a745;
    }
    .period-selector-sm a.active {
        background: #28a745;
        color: #fff;
    }

    /* ‚îÄ‚îÄ‚îÄ Custom Date Range Picker (compact) ‚îÄ‚îÄ‚îÄ */
    .date-range-picker-sm {
        background: #ffffff;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 6px 12px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.04);
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
    }
    .date-range-picker-sm label {
        font-size: 0.72rem;
        font-weight: 600;
        color: #666;
        margin-bottom: 0;
        white-space: nowrap;
    }
    .date-range-picker-sm input[type="date"] {
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 4px 8px;
        font-size: 0.78rem;
        color: #333;
        min-width: 130px;
    }
    .date-range-picker-sm input[type="date"]:focus {
        outline: none;
        border-color: #28a745;
        box-shadow: 0 0 0 2px rgba(40,167,69,0.1);
    }
    .date-range-picker-sm button {
        background: #28a745;
        color: white;
        border: none;
        border-radius: 5px;
        padding: 4px 14px;
        font-size: 0.78rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.15s;
        white-space: nowrap;
    }
    .date-range-picker-sm button:hover { background: #218838; }
    .date-range-picker-sm .reset-btn { background: #6c757d; padding: 4px 10px; }
    .date-range-picker-sm .reset-btn:hover { background: #5a6268; }
</style>
{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    {% for crumb in breadcrumbs %}
        {% if crumb.url %}
            <a href="{{ crumb.url }}{% if period_code %}?period={{ period_code }}{% endif %}">{{ crumb.title }}</a>
        {% else %}
            <span style="font-weight: 600; color: #333;">{{ crumb.title }}</span>
        {% endif %}
        {% if not forloop.last %} <span style="margin: 0 8px; color: #ccc;">&rsaquo;</span> {% endif %}
    {% endfor %}
</div>
{% endblock %}

{% block content %}
<div class="container-fluid p-4" style="min-height: 100vh;">
    
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-3">
        <div>
            <h1 class="h4 fw-bold text-main-black mb-1">
                <span style="color: #28a745;">#</span> {{ stat }}
            </h1>
            <p class="text-main-muted small mb-0">–î–µ—Ç–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –ø–æ–∫–∞–∑–∞—Ç–µ–ª—é</p>
        </div>

        <div class="d-flex align-items-center gap-3 flex-wrap">
            {# –ë—ã—Å—Ç—Ä—ã–µ –∫–Ω–æ–ø–∫–∏ –ø–µ—Ä–∏–æ–¥–∞ #}
            <div class="period-selector-sm">
                {% for code, meta in period_choices.items %}
                    <a href="?period={{ code }}{% if selected_branch_id %}&branch={{ selected_branch_id }}{% endif %}"
                       class="{% if code == period_code and not custom_date_from %}active{% endif %}">{{ meta.0 }}</a>
                {% endfor %}
            </div>

            {# –ö–∞—Å—Ç–æ–º–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç #}
            <div class="date-range-picker-sm">
                <label>üìÖ</label>
                <input type="date" id="detail_date_from"
                       value="{{ custom_date_from|default:'' }}" placeholder="–û—Ç">
                <span style="color:#999">‚Äî</span>
                <input type="date" id="detail_date_to"
                       value="{{ custom_date_to|default:'' }}" placeholder="–î–æ">
                <button type="button" onclick="applyDetailPeriod()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                {% if custom_date_from %}
                <button type="button" class="reset-btn" onclick="resetDetailPeriod()">–°–±—Ä–æ—Å–∏—Ç—å</button>
                {% endif %}
            </div>

            <div class="badge bg-white border text-dark py-2 px-3 shadow-sm" style="border-radius: 8px;">
                –í—Å–µ–≥–æ: <span class="fw-bold" style="color: #28a745;">{{ clients|length }}</span>
            </div>
        </div>
    </div>

    {% if external_stat %}
    {# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑ –≤–Ω–µ—à–Ω–∏—Ö —Å–∏—Å—Ç–µ–º (VK API / POS) ‚Äî —Å–ø–∏—Å–æ–∫ –≥–æ—Å—Ç–µ–π –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω #}
    <div class="custom-table-container p-5 text-center">
        <div class="mb-3 fs-1">üîå</div>
        <h5 class="fw-bold text-main-black mb-2">–î–∞–Ω–Ω—ã–µ –∏–∑ –≤–Ω–µ—à–Ω–µ–π —Å–∏—Å—Ç–µ–º—ã</h5>
        <p class="text-main-muted mb-0">
            –≠—Ç–æ—Ç –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö VK API –∏–ª–∏ POS-—Å–∏—Å—Ç–µ–º—ã.<br>
            –î–µ—Ç–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –≥–æ—Å—Ç–µ–π –¥–ª—è —ç—Ç–æ–π –º–µ—Ç—Ä–∏–∫–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.
        </p>
    </div>
    {% else %}
    <div class="custom-table-container">
        <div class="table-responsive">
            <table class="table align-middle">
                <thead>
                    <tr>
                        <th>–ö–ª–∏–µ–Ω—Ç</th>
                        <th>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</th>
                        <th class="text-center">–°—Ç–æ—Ä–∏—Å</th>
                        <th class="text-center">–°–æ–æ–±—â–µ—Å—Ç–≤–æ</th>
                        <th class="text-center">–ò–Ω–≤–∞–π—Ç</th>
                    </tr>
                </thead>
                <tbody>
                    {% for client in clients %}
                    <tr>
                        <td>
                            <div class="fw-bold text-main-black">{{ client.client.name }} {{ client.client.lastname }}</div>
                            <small class="text-main-muted">ID: {{ client.client.vk_user_id }}</small>
                        </td>
                        <td>
                            {% if client.birth_date %}
                                <span class="text-main-black">{{ client.birth_date|date:"d M Y" }}</span>
                            {% else %}
                                <span class="text-main-muted">‚Äî</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% if client.is_story_uploaded %}
                                <span class="status-badge status-true">–î–∞</span>
                            {% else %}
                                <span class="status-badge status-false">–ù–µ—Ç</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% if client.is_joined_community %}
                                <span class="status-badge status-true">–î–∞</span>
                            {% else %}
                                <span class="status-badge status-false">–ù–µ—Ç</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% if client.invited_by %}
                                <span class="status-badge status-true">–î–∞</span>
                            {% else %}
                                <span class="status-badge status-false">–ù–µ—Ç</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center py-5 text-main-muted">
                            <div class="mb-2 fs-2">üìÇ</div>
                            –î–∞–Ω–Ω—ã–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

<script>
    function applyDetailPeriod() {
        const dateFrom = document.getElementById('detail_date_from').value;
        const dateTo = document.getElementById('detail_date_to').value;
        if (!dateFrom || !dateTo) { alert('–í—ã–±–µ—Ä–∏—Ç–µ –æ–±–µ –¥–∞—Ç—ã'); return; }
        if (new Date(dateFrom) > new Date(dateTo)) { alert('–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–∑–∂–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è'); return; }
        const branch = '{{ selected_branch_id|default:"" }}';
        let url = '?custom_date_from=' + dateFrom + '&custom_date_to=' + dateTo;
        if (branch) url += '&branch=' + branch;
        window.location.href = url;
    }
    function resetDetailPeriod() {
        const branch = '{{ selected_branch_id|default:"" }}';
        let url = '?period=30d';
        if (branch) url += '&branch=' + branch;
        window.location.href = url;
    }
    document.addEventListener('DOMContentLoaded', function () {
        ['detail_date_from', 'detail_date_to'].forEach(function(id) {
            var el = document.getElementById(id);
            if (el) el.addEventListener('keypress', function(e) { if (e.key === 'Enter') applyDetailPeriod(); });
        });
    });
</script>
