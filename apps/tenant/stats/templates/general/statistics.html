{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block extrastyle %}
{{ block.super }}
<!-- Bootstrap 5.3 CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
<!-- Bootstrap Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
<style>
    /* 1. Dashboard Layout */
    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
    }

    /* 2. Light Theme Cards */
    .stat-card {
        background: #ffffff;
        border: 1px solid #e0e0e0 !important;
        border-radius: 12px;
        padding: 24px;
        text-decoration: none !important;
        transition: all 0.2s ease-in-out;
        display: flex;
        flex-direction: column;
        justify-content: center;
        height: 100%;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .stat-card:hover {
        transform: translateY(-3px);
        border-color: #28a745 !important;
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1) !important;
        background: #f8fff9;
    }

    /* 3. Typography - Dark text for Light BG */
    .stat-card h3 {
        color: #666;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 700;
        margin-bottom: 12px;
        text-align: left;
    }

    .stat-card .metric {
        font-size: 2.2rem;
        font-weight: 800;
        color: #212529;
        line-height: 1;
    }

    .section-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #333;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    /* 4. Chart Containers */
    .chart-container {
        background: #ffffff;
        border: 1px solid #e0e0e0;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .chart-container h3 {
        color: #333;
        font-size: 0.9rem;
        font-weight: 600;
        margin-bottom: 20px;
        text-align: center;
    }

    /* Text colors for light theme */
    .text-custom-dark {
        color: #444 !important;
    }

    .text-custom-muted {
        color: #777 !important;
    }

    /* ‚ïê‚ïê‚ïê Fix: Bootstrap vs Django Admin Sidebar ‚ïê‚ïê‚ïê */
    #container, #header, #nav-sidebar,
    #container *, #header *, #nav-sidebar * {
        box-sizing: content-box !important;
    }

    #nav-sidebar {
        position: sticky !important;
        top: 0 !important;
        max-height: 100vh !important;
        overflow-x: hidden !important;
        overflow-y: auto !important;
        width: 275px !important;
        flex-shrink: 0 !important;
    }

    #nav-sidebar ul {
        padding-left: 0;
        margin-bottom: 0;
        list-style: none;
    }
    #nav-sidebar li {
        list-style: none;
    }

    #nav-sidebar, #nav-sidebar * {
        scroll-behavior: auto !important;
    }

    #content, #content * {
        box-sizing: border-box !important;
    }

    /* ‚îÄ‚îÄ‚îÄ Period Selector ‚îÄ‚îÄ‚îÄ */
    .period-selector {
        display: inline-flex;
        gap: 0;
        background: #ffffff;
        border: 1px solid #e0e0e0;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    }
    .period-selector a {
        padding: 8px 16px;
        font-size: 0.8rem;
        font-weight: 600;
        color: #555;
        text-decoration: none;
        border-right: 1px solid #e8e8e8;
        transition: all 0.15s;
        white-space: nowrap;
    }
    .period-selector a:last-child {
        border-right: none;
    }
    .period-selector a:hover {
        background: #f0faf1;
        color: #28a745;
    }
    .period-selector a.active {
        background: #28a745;
        color: #fff;
    }

    /* ‚îÄ‚îÄ‚îÄ Custom Date Range Picker ‚îÄ‚îÄ‚îÄ */
    .date-range-picker {
        background: #ffffff;
        border: 1px solid #e0e0e0;
        border-radius: 10px;
        padding: 12px 16px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.06);
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
    }
    
    .date-range-picker label {
        font-size: 0.75rem;
        font-weight: 600;
        color: #666;
        margin-bottom: 0;
        white-space: nowrap;
    }
    
    .date-range-picker input[type="date"] {
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 6px 10px;
        font-size: 0.85rem;
        color: #333;
        transition: all 0.15s;
        min-width: 150px;
    }
    
    .date-range-picker input[type="date"]:focus {
        outline: none;
        border-color: #28a745;
        box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.1);
    }
    
    .date-range-picker button {
        background: #28a745;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 6px 20px;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.15s;
        white-space: nowrap;
    }
    
    .date-range-picker button:hover {
        background: #218838;
        transform: translateY(-1px);
        box-shadow: 0 2px 6px rgba(40, 167, 69, 0.3);
    }
    
    .date-range-picker button:active {
        transform: translateY(0);
    }

    .date-range-picker .reset-btn {
        background: #6c757d;
        padding: 6px 16px;
    }
    
    .date-range-picker .reset-btn:hover {
        background: #5a6268;
        box-shadow: 0 2px 6px rgba(108, 117, 125, 0.3);
    }

    .period-controls-wrapper {
        display: flex;
        flex-direction: column;
        gap: 8px;
        align-items: flex-end;
    }

    /* ‚îÄ‚îÄ‚îÄ Branch Selector ‚îÄ‚îÄ‚îÄ */
    .branch-selector {
        display: inline-flex;
        gap: 0;
        background: #ffffff;
        border: 1px solid #e0e0e0;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0,0,0,0.06);
        max-width: 100%;
        flex-wrap: wrap;
    }
    .branch-selector a {
        padding: 8px 16px;
        font-size: 0.8rem;
        font-weight: 600;
        color: #555;
        text-decoration: none;
        border-right: 1px solid #e8e8e8;
        transition: all 0.15s;
        white-space: nowrap;
    }
    .branch-selector a:last-child {
        border-right: none;
    }
    .branch-selector a:hover {
        background: #f0f0ff;
        color: #4c66a4;
    }
    .branch-selector a.active {
        background: #4c66a4;
        color: #fff;
    }

    /* ‚îÄ‚îÄ‚îÄ (POS table styles removed ‚Äî table moved to metrics) ‚îÄ‚îÄ‚îÄ */

    /* ‚îÄ‚îÄ‚îÄ Reviews Panel ‚îÄ‚îÄ‚îÄ */
    .reviews-panel {
        background: #ffffff;
        border: 1px solid #e0e0e0;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .reviews-panel-header {
        padding: 16px 20px;
        background: #f8f9fa;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 8px;
    }

    .reviews-panel-title {
        font-size: 0.9rem;
        font-weight: 700;
        color: #333;
        margin: 0;
        letter-spacing: 0.5px;
    }

    .reviews-sentiment-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 0;
    }

    .sentiment-card {
        padding: 20px 16px;
        text-align: center;
        text-decoration: none !important;
        border-right: 1px solid #f0f0f0;
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .sentiment-card:last-child {
        border-right: none;
    }

    .sentiment-card:hover {
        background: #f8f9fa;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.08);
    }

    .sentiment-label {
        font-size: 0.65rem;
        font-weight: 700;
        letter-spacing: 0.5px;
        text-transform: uppercase;
        margin-bottom: 8px;
    }

    .sentiment-count {
        font-size: 2rem;
        font-weight: 800;
        line-height: 1;
    }

    .sentiment-positive .sentiment-label { color: #28a745; }
    .sentiment-positive .sentiment-count { color: #28a745; }
    .sentiment-positive:hover { background: #f0faf2; }

    .sentiment-negative .sentiment-label { color: #dc3545; }
    .sentiment-negative .sentiment-count { color: #dc3545; }
    .sentiment-negative:hover { background: #fdf0f1; }

    .sentiment-neutral .sentiment-label { color: #fd7e14; }
    .sentiment-neutral .sentiment-count { color: #fd7e14; }
    .sentiment-neutral:hover { background: #fff8f0; }

    .sentiment-spam .sentiment-label { color: #6c757d; }
    .sentiment-spam .sentiment-count { color: #6c757d; }
    .sentiment-spam:hover { background: #f5f5f5; }
</style>
{% endblock %}

{% block content %}
<div class="p-4" style="background-color: #f4f7f6; min-height: 100vh;">

    <div class="d-flex flex-wrap justify-content-between align-items-start mb-3 gap-3">
        <div>
            <h1 class="section-title mb-0">
                <span style="background: rgba(40, 167, 69, 0.1); padding: 4px; border-radius: 8px;">üìä</span>
                –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ‚Äî {{ tenant_name|default:"–í—Å–µ –∫–ª–∏–µ–Ω—Ç—ã" }}
            </h1>
            {% if selected_branch %}
                <p class="text-custom-dark fs-5 mb-0 mt-2">
                    –§–∏–ª–∏–∞–ª: <strong>{{ selected_branch.name }}</strong>
                </p>
            {% endif %}
        </div>

        

        <div class="d-flex flex-column gap-2 align-items-end">
            {# ‚îÄ‚îÄ –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ñ–∏–ª–∏–∞–ª–∞ ‚îÄ‚îÄ #}
            <div class="branch-selector">
                <a href="?{% if period_code %}period={{ period_code }}{% endif %}"
                   class="{% if not selected_branch %}active{% endif %}">
                    üè¢ –í—Å–µ —Ç–æ—á–∫–∏
                </a>
                {% for branch in all_branches %}
                    <a href="?branch={{ branch.id }}{% if period_code %}&period={{ period_code }}{% endif %}"
                       class="{% if selected_branch and selected_branch.id == branch.id %}active{% endif %}">
                        {{ branch.name }}
                    </a>
                {% endfor %}
            </div>

            {# ‚îÄ‚îÄ –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –ø–µ—Ä–∏–æ–¥–∞ –∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—å ‚îÄ‚îÄ #}
            <div class="period-controls-wrapper">
                {# –ë—ã—Å—Ç—Ä—ã–µ –∫–Ω–æ–ø–∫–∏ –ø–µ—Ä–∏–æ–¥–æ–≤ #}
                <div class="period-selector">
                    {% for code, meta in period_choices.items %}
                        <a href="?{% if selected_branch_id %}branch={{ selected_branch_id }}&{% endif %}period={{ code }}"
                           class="{% if code == period_code and not custom_date_from %}active{% endif %}">
                            {{ meta.0 }}
                        </a>
                    {% endfor %}
                </div>
                
                {# –ö–∞–ª–µ–Ω–¥–∞—Ä—å –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –≤—ã–±–æ—Ä–∞ #}
                <div class="date-range-picker">
                    <label for="custom_date_from">üìÖ –ü–µ—Ä–∏–æ–¥:</label>
                    <input 
                        type="date" 
                        id="custom_date_from" 
                        name="custom_date_from" 
                        value="{{ custom_date_from|default:'' }}"
                        placeholder="–û—Ç">
                    <span style="color: #999;">‚Äî</span>
                    <input 
                        type="date" 
                        id="custom_date_to" 
                        name="custom_date_to" 
                        value="{{ custom_date_to|default:'' }}"
                        placeholder="–î–æ">
                    <button type="button" onclick="applyCustomPeriod()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                    {% if custom_date_from %}
                    <button type="button" class="reset-btn" onclick="resetPeriod()">–°–±—Ä–æ—Å–∏—Ç—å</button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <p class='text-custom-dark fs-6 mb-1'>
        {% if selected_branch %}
            –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—É <strong>{{ selected_branch.name }}</strong>
        {% else %}
            –°–≤–æ–¥–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤—Å–µ–º —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞–º
        {% endif %}
    </p>
    <p class='text-custom-muted fs-6 mb-4'>
        –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –ø–æ –∫–∞–∂–¥–æ–º—É —Ä–µ—Å—Ç–æ—Ä–∞–Ω—É —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –æ—Ç–∫—Ä—ã—Ç—å <strong>RFM-—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</strong>.
        {% if custom_date_from and custom_date_to %}
            <span class="badge bg-light text-dark border ms-1" style="font-size:.78rem">
                <i class="bi bi-calendar3"></i> 
                {{ custom_date_from }} ‚Äî {{ custom_date_to }}
            </span>
        {% elif period_code != 'all' %}
            <span class="badge bg-light text-dark border ms-1" style="font-size:.78rem">
                <i class="bi bi-calendar3"></i> 
                {% for code, meta in period_choices.items %}{% if code == period_code %}{{ meta.0 }}{% endif %}{% endfor %}
            </span>
        {% endif %}
    </p>

    {# ‚îÄ‚îÄ –¢–∞–±–ª–∏—Ü–∞ POS –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º —É–¥–∞–ª–µ–Ω–∞: –¥–∞–Ω–Ω—ã–µ —É–∂–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω—ã –≤ –º–µ—Ç—Ä–∏–∫–∞—Ö ‚îÄ‚îÄ #}

    {# ‚îÄ‚îÄ –ê–Ω–∞–ª–∏–∑ –æ—Ç–∑—ã–≤–æ–≤ –∏–∑ –í–ö ‚îÄ‚îÄ #}
    {% if stats.testimonials.total %}
    <div class="reviews-panel mb-4">
        <div class="reviews-panel-header">
            <h3 class="reviews-panel-title">
                üí¨ –ê–ù–ê–õ–ò–ó –û–¢–ó–´–í–û–í –ò–ó –í–ö
            </h3>
            <span class="badge bg-light text-dark border" style="font-size:.78rem">
                <i class="bi bi-calendar3"></i>
                {% if custom_date_from and custom_date_to %}
                    {{ custom_date_from }} ‚Äî {{ custom_date_to }}
                {% else %}
                    {% for code, meta in period_choices.items %}{% if code == period_code %}{{ meta.0 }}{% endif %}{% endfor %}
                {% endif %}
            </span>
        </div>
        <div class="reviews-sentiment-grid">
            <a href="{% url 'admin-reviews-list' %}?sentiment=POSITIVE{% if selected_branch_id %}&branch={{ selected_branch_id }}{% endif %}{% if custom_date_from %}&custom_date_from={{ custom_date_from }}&custom_date_to={{ custom_date_to }}{% elif period_code %}&period={{ period_code }}{% endif %}" class="sentiment-card sentiment-positive">
                <div class="sentiment-label">–ü–û–ó–ò–¢–ò–í–ù–´–ô</div>
                <div class="sentiment-count">{{ stats.testimonials.positive|default:0 }}</div>
            </a>
            <a href="{% url 'admin-reviews-list' %}?sentiment=NEGATIVE{% if selected_branch_id %}&branch={{ selected_branch_id }}{% endif %}{% if custom_date_from %}&custom_date_from={{ custom_date_from }}&custom_date_to={{ custom_date_to }}{% elif period_code %}&period={{ period_code }}{% endif %}" class="sentiment-card sentiment-negative">
                <div class="sentiment-label">–ù–ï–ì–ê–¢–ò–í–ù–´–ô</div>
                <div class="sentiment-count">{{ stats.testimonials.negative|default:0 }}</div>
            </a>
            <a href="{% url 'admin-reviews-list' %}?sentiment=NEUTRAL{% if selected_branch_id %}&branch={{ selected_branch_id }}{% endif %}{% if custom_date_from %}&custom_date_from={{ custom_date_from }}&custom_date_to={{ custom_date_to }}{% elif period_code %}&period={{ period_code }}{% endif %}" class="sentiment-card sentiment-neutral">
                <div class="sentiment-label">–ß–ê–°–¢–ò–ß–ù–û –ù–ï–ì–ê–¢–ò–í–ù–´–ô</div>
                <div class="sentiment-count">{{ stats.testimonials.neutral|default:0 }}</div>
            </a>
            <a href="{% url 'admin-reviews-list' %}?sentiment=SPAM{% if selected_branch_id %}&branch={{ selected_branch_id }}{% endif %}{% if custom_date_from %}&custom_date_from={{ custom_date_from }}&custom_date_to={{ custom_date_to }}{% elif period_code %}&period={{ period_code }}{% endif %}" class="sentiment-card sentiment-spam">
                <div class="sentiment-label">–°–ü–ê–ú / –ù–ï –ü–û –¢–ï–ú–ï</div>
                <div class="sentiment-count">{{ stats.testimonials.spam|default:0 }}</div>
            </a>
        </div>
    </div>
    {% endif %}

    <div class="dashboard-grid">
        {# period_params is built in the view (StatisticsView.get_context_data) to avoid {% with %} scoping issues #}

        <a href="{% url 'admin-statistics-detail' stat_name='total_clients' %}?{{ period_params }}" class="stat-card">
            <h3>–û—Ü–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ –≥–æ—Å—Ç–∏ –≤—Å–µ–≥–æ</h3>
            <div class="metric">{{ stats.total_clients|default:0 }}</div>
        </a>

        <a href="{% url 'admin-statistics-detail' stat_name='total_clients_last_month' %}?{{ period_params }}" class="stat-card">
            <h3>–ù–æ–≤—ã–µ –∑–∞ –ø–µ—Ä–∏–æ–¥</h3>
            <div class="metric" style="color: #28a745;">{{ stats.total_clients_period|default:0 }}</div>
        </a>

        <a href="{% url 'admin-statistics-detail' stat_name='new_clients_received_super_prize' %}?{{ period_params }}" class="stat-card">
            <h3>–ù–æ–≤—ã–µ + 1-–π –ø–æ–¥–∞—Ä–æ–∫</h3>
            <div class="metric">{{ stats.new_clients_received_super_prize|default:0 }}</div>
        </a>

        <a href="{% url 'admin-statistics-detail' stat_name='clients_returned_second_time' %}?{{ period_params }}" class="stat-card">
            <h3>–í–µ—Ä–Ω—É–ª–∏—Å—å –ø–æ–≤—Ç–æ—Ä–Ω–æ</h3>
            <div class="metric" style="color: #17a2b8;">{{ stats.clients_returned_second_time|default:0 }}</div>
        </a>

        <div class="stat-card" style="border-left: 4px solid #e91e63 !important;">
            <h3>üéÇ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–π –î–†</h3>
            <div class="metric">{{ stats.sent_greetings|default:0 }}</div>
        </div>

        <div class="stat-card" style="border-left: 4px solid #9c27b0 !important;">
            <h3>üéÅ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ –ø–æ–¥–∞—Ä–∫–æ–≤ –î–†</h3>
            <div class="metric" style="color: #9c27b0;">{{ stats.activated_birthday_prizes|default:0 }}</div>
        </div>

        <div class="stat-card" style="border-left: 4px solid #00bcd4 !important;">
            <h3>üì® % –æ—Ç–∫—Ä—ã–≤–∞–µ–º–æ—Å—Ç–∏</h3>
            <div class="metric" style="color: #00bcd4;">{{ stats.open_rate|default:0 }}%</div>
            <small class="text-muted">–ü—Ä–æ—á–∏—Ç–∞–Ω–æ / –î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ</small>
        </div>

        <a href="{% url 'admin-statistics-detail' stat_name='clients_bought_prizes' %}?{{ period_params }}" class='stat-card'>
            <h3>–ö—É–ø–∏–ª–∏ –ø–æ–¥–∞—Ä–∫–∏ –∑–∞ –±–∞–ª–ª—ã</h3>
            <div class="metric">{{ stats.clients_bought_prizes|default:0 }}</div>
        </a>

        <a href="{% url 'admin-statistics-detail' stat_name='clients_posted_story' %}?{{ period_params }}" class="stat-card">
            <h3>–û–ø—É–±–ª–∏–∫–æ–≤–∞–ª–∏ –∏—Å—Ç–æ—Ä–∏–∏</h3>
            <div class="metric" style="color: #dc3545;">{{ stats.clients_posted_story|default:0 }}</div>
        </a>

        <a href="{% url 'admin-statistics-detail' stat_name='clients_from_referral' %}?{{ period_params }}" class="stat-card">
            <h3>–ü—Ä–∏—à–ª–∏ –∏–∑ –∏—Å—Ç–æ—Ä–∏–π</h3>
            <div class="metric">{{ stats.clients_from_referral|default:0 }}</div>
        </a>

        <div class="stat-card" style="border-left: 4px solid #6f42c1 !important;">
            <h3>üîÑ –ò–Ω–¥–µ–∫—Å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
            <div class="metric" style="color: #6f42c1;">{{ stats.scan_index|default:0 }}%</div>
            <small class="text-muted">QR —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è √∑ –ì–æ—Å—Ç–∏ POS —Å–∏—Å—Ç–µ–º—ã</small>
        </div>

        <div class="stat-card">
            <h3>üì± QR —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –∑–∞ –ø–µ—Ä–∏–æ–¥</h3>
            <div class="metric">{{ stats.qr_scans_today|default:0 }}</div>
            <small class="text-muted">
                {% if custom_date_from and custom_date_to %}
                    {{ custom_date_from }} ‚Äî {{ custom_date_to }}
                {% else %}
                    {% for code, meta in period_choices.items %}{% if code == period_code %}{{ meta.0 }}{% endif %}{% endfor %}
                {% endif %}
            </small>
        </div>

        <div class="stat-card">
            <h3>üë• –ì–æ—Å—Ç–µ–π –ø–æ POS —Å–∏—Å—Ç–µ–º–µ</h3>
            <div class="metric">{{ stats.pos_guests_today|default:0 }}</div>
            <small class="text-muted">
                IIKO / Dooglys
                ¬∑ {% if custom_date_from and custom_date_to %}
                    {{ custom_date_from }} ‚Äî {{ custom_date_to }}
                {% else %}
                    {% for code, meta in period_choices.items %}{% if code == period_code %}{{ meta.0 }}{% endif %}{% endfor %}
                {% endif %}
            </small>
        </div>

        <div class="stat-card">
            <h3>üì¨ –ü–æ–¥–ø–∏—Å–∞–ª–∏—Å—å –≤ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ VK</h3>
            <div class="metric">{{ stats.group_subscribers|default:0 }}</div>
            {% if selected_branch %}<small class="text-muted">–û–±—â–∏–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å (–Ω–µ –ø–æ —Ç–æ—á–∫–µ)</small>{% endif %}
        </div>

        <div class="stat-card">
            <h3>üì® –ü–æ–¥–ø–∏—Å–∞–ª–∏—Å—å –Ω–∞ —Ä–∞—Å—Å—ã–ª–∫—É</h3>
            <div class="metric">{{ stats.mailing_subscribers|default:0 }}</div>
            {% if selected_branch %}<small class="text-muted">–û–±—â–∏–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å (–Ω–µ –ø–æ —Ç–æ—á–∫–µ)</small>{% endif %}
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-12 col-md-6 col-lg-3">
            <div class="chart-container">
                <h3>–ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –≤–∏–∑–∏—Ç—ã</h3>
                <canvas id="returnChart"></canvas>
            </div>
        </div>
        <div class="col-12 col-md-6 col-lg-3">
            <div class="chart-container">
                <h3>–ò—Å—Ç–æ—á–Ω–∏–∫–∏: –∏–∑ –∫–∞—Ñ–µ/–∏–∑ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã—Ö –∏—Å—Ç–æ—Ä–∏–π</h3>
                <canvas id="referralChart"></canvas>
            </div>
        </div>
        <div class="col-12 col-md-6 col-lg-3">
            <div class="chart-container">
                <h3>–ò—Å—Ç–æ—Ä–∏–∏: –æ–ø—É–±–ª–∏–∫–æ–≤–∞–ª–∏/–Ω–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–ª–∏</h3>
                <canvas id="activityChart"></canvas>
            </div>
        </div>
        <div class="col-12 col-md-6 col-lg-3">
            <div class="chart-container">
                <h3>–ü–æ–¥–∞—Ä–∫–∏: —Ç–æ–ª—å–∫–æ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π/–ø–æ–∫—É–ø–∞–ª–∏ –∑–∞ –±–∞–ª–ª—ã</h3>
                <canvas id="engagementChart"></canvas>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-5">
        <div class="col-12 col-md-6 col-lg-3">
            <div class="chart-container">
                <h3>–í–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª–∞/–ö–∞—á–µ—Å—Ç–≤–æ —Ä–µ–∫–ª–∞–º–Ω–æ–≥–æ –Ω–æ—Å–∏—Ç–µ–ª—è</h3>
                <canvas id="staffEngagementChart"></canvas>
            </div>
        </div>
        <div class="col-12 col-md-6 col-lg-3">
            <div class="chart-container">
                <h3>–ò–Ω–¥–µ–∫—Å –∫–∞—á–µ—Å—Ç–≤–∞: –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–π/–ø–æ–∑–∏—Ç–∏–≤–Ω—ã–π/—á–∞—Å—Ç–∏—á–Ω–æ –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–π</h3>
                <canvas id="qualityIndexChart"></canvas>
            </div>
        </div>
        <div class="col-12 col-md-6 col-lg-3">
            <div class="chart-container">
                <h3>–û—Ç–∑—ã–≤—ã: –æ—Å—Ç–∞–≤–∏–ª–∏/–Ω–µ –æ—Å—Ç–∞–≤–∏–ª–∏</h3>
                <canvas id="reviewsChart"></canvas>
            </div>
        </div>
        <div class="col-12 col-md-6 col-lg-3">
            <div class="chart-container">
                <h3>–ó–∞–¥–∞–Ω–∏—è: –í—ã–ø–æ–ª–Ω—è–ª–∏/–Ω–µ –≤—ã–ø–æ–ª–Ω—è–ª–∏</h3>
                <canvas id="questsChart"></canvas>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Global Chart.js Defaults for Light Mode
    Chart.defaults.color = '#555';
    Chart.defaults.font.family = "'Inter', sans-serif";

    const commonOptions = {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom',
                labels: { padding: 15, usePointStyle: true, font: { size: 11 } }
            }
        },
        borderWidth: 2,
        borderColor: '#ffffff'
    };

    const total = {{ stats.total_clients|default:0 }};
    const emptyColor = '#f0f0f0';

    // 1. –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –≤–∏–∑–∏—Ç—ã (–Ω–∞ –ø–µ—Ä–≤–æ–º –º–µ—Å—Ç–µ)
    new Chart(document.getElementById('returnChart'), {
        type: 'doughnut',
        data: {
            labels: ['–ü–æ–≤—Ç–æ—Ä–Ω–æ', '–†–∞–∑–æ–≤–æ'],
            datasets: [{
                data: [{{ stats.clients_returned_second_time|default:0 }}, Math.max(total - {{ stats.clients_returned_second_time|default:0 }}, 0)],
                backgroundColor: ['#17a2b8', emptyColor]
            }]
        },
        options: { ...commonOptions, cutout: '75%' }
    });

    // 2. –ò—Å—Ç–æ—á–Ω–∏–∫–∏: –∏–∑ –∫–∞—Ñ–µ/–∏–∑ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã—Ö –∏—Å—Ç–æ—Ä–∏–π
    new Chart(document.getElementById('referralChart'), {
        type: 'doughnut',
        data: {
            labels: ['–ò–∑ –∏—Å—Ç–æ—Ä–∏–π', '–ò–∑ –∫–∞—Ñ–µ'],
            datasets: [{
                data: [{{ stats.clients_from_referral|default:0 }}, Math.max(total - {{ stats.clients_from_referral|default:0 }}, 0)],
                backgroundColor: ['#28a745', emptyColor]
            }]
        },
        options: { ...commonOptions, cutout: '75%' }
    });

    // 3. –ò—Å—Ç–æ—Ä–∏–∏: –æ–ø—É–±–ª–∏–∫–æ–≤–∞–ª–∏/–Ω–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–ª–∏
    new Chart(document.getElementById('activityChart'), {
        type: 'doughnut',
        data: {
            labels: ['–û–ø—É–±–ª–∏–∫–æ–≤–∞–ª–∏', '–ù–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–ª–∏'],
            datasets: [{
                data: [{{ stats.clients_posted_story|default:0 }}, Math.max(total - {{ stats.clients_posted_story|default:0 }}, 0)],
                backgroundColor: ['#dc3545', emptyColor]
            }]
        },
        options: { ...commonOptions, cutout: '75%' }
    });

    // 4. –ü–æ–¥–∞—Ä–∫–∏: —Ç–æ–ª—å–∫–æ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π/–ø–æ–∫—É–ø–∞–ª–∏ –∑–∞ –±–∞–ª–ª—ã
    new Chart(document.getElementById('engagementChart'), {
        type: 'doughnut',
        data: {
            labels: ['–¢–æ–ª—å–∫–æ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π', '–ü–æ–∫—É–ø–∞–ª–∏ –∑–∞ –±–∞–ª–ª—ã'],
            datasets: [{
                data: [
                    {{ stats.new_clients_received_super_prize|default:0 }},
                    {{ stats.clients_bought_prizes|default:0 }}
                ],
                backgroundColor: ['#ffc107', '#6610f2']
            }]
        },
        options: { ...commonOptions, cutout: '75%' }
    });

    // 5. –í–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª–∞/–ö–∞—á–µ—Å—Ç–≤–æ —Ä–µ–∫–ª–∞–º–Ω–æ–≥–æ –Ω–æ—Å–∏—Ç–µ–ª—è
    const staffIndex = {{ stats.staff_engagement_index|default:0 }};
    new Chart(document.getElementById('staffEngagementChart'), {
        type: 'doughnut',
        data: {
            labels: ['–í–æ–≤–ª–µ—á—ë–Ω–Ω–æ—Å—Ç—å', '–û—Å—Ç–∞–ª—å–Ω—ã–µ'],
            datasets: [{
                data: [staffIndex, Math.max(100 - staffIndex, 0)],
                backgroundColor: ['#e91e63', emptyColor]
            }]
        },
        options: {
            ...commonOptions,
            cutout: '75%',
            plugins: {
                ...commonOptions.plugins,
                centerText: true
            }
        },
        plugins: [{
            id: 'centerText',
            afterDraw(chart) {
                const { ctx, chartArea: { width, height, top } } = chart;
                ctx.save();
                ctx.font = 'bold 1.5rem Inter, sans-serif';
                ctx.fillStyle = '#e91e63';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(staffIndex + '%', width / 2, top + height / 2);
                ctx.restore();
            }
        }]
    });

    // 6. –ò–Ω–¥–µ–∫—Å –∫–∞—á–µ—Å—Ç–≤–∞: –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–π/–ø–æ–∑–∏—Ç–∏–≤–Ω—ã–π/—á–∞—Å—Ç–∏—á–Ω–æ –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–π
    const tPositive = {{ stats.testimonials.positive|default:0 }};
    const tNegative = {{ stats.testimonials.negative|default:0 }};
    const tNeutral = {{ stats.testimonials.neutral|default:0 }};
    const tTotal = tPositive + tNegative + tNeutral;
    new Chart(document.getElementById('qualityIndexChart'), {
        type: 'doughnut',
        data: {
            labels: ['–ü–æ–∑–∏—Ç–∏–≤–Ω—ã–π', '–ù–µ–≥–∞—Ç–∏–≤–Ω—ã–π', '–ß–∞—Å—Ç–∏—á–Ω–æ –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–π'],
            datasets: [{
                data: tTotal > 0 ? [tPositive, tNegative, tNeutral] : [0, 0, 1],
                backgroundColor: tTotal > 0 ? ['#28a745', '#dc3545', '#fd7e14'] : [emptyColor, emptyColor, emptyColor]
            }]
        },
        options: { ...commonOptions, cutout: '75%' }
    });

    // 7. –û—Ç–∑—ã–≤—ã: –æ—Å—Ç–∞–≤–∏–ª–∏/–Ω–µ –æ—Å—Ç–∞–≤–∏–ª–∏
    const leftReview = {{ stats.clients_left_review|default:0 }};
    new Chart(document.getElementById('reviewsChart'), {
        type: 'doughnut',
        data: {
            labels: ['–û—Å—Ç–∞–≤–∏–ª–∏', '–ù–µ –æ—Å—Ç–∞–≤–∏–ª–∏'],
            datasets: [{
                data: [leftReview, Math.max(total - leftReview, 0)],
                backgroundColor: ['#6f42c1', emptyColor]
            }]
        },
        options: { ...commonOptions, cutout: '75%' }
    });

    // 8. –ó–∞–¥–∞–Ω–∏—è: –í—ã–ø–æ–ª–Ω—è–ª–∏/–Ω–µ –≤—ã–ø–æ–ª–Ω—è–ª–∏
    const questsDone = {{ stats.quests_completed|default:0 }};
    const questsNotDone = {{ stats.quests_not_completed|default:0 }};
    const questsTotal = questsDone + questsNotDone;
    new Chart(document.getElementById('questsChart'), {
        type: 'doughnut',
        data: {
            labels: ['–í—ã–ø–æ–ª–Ω—è–ª–∏', '–ù–µ –≤—ã–ø–æ–ª–Ω—è–ª–∏'],
            datasets: [{
                data: questsTotal > 0 ? [questsDone, questsNotDone] : [0, 1],
                backgroundColor: questsTotal > 0 ? ['#00bcd4', emptyColor] : [emptyColor, emptyColor]
            }]
        },
        options: { ...commonOptions, cutout: '75%' }
    });
</script>

<script>
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞
    function applyCustomPeriod() {
        const dateFrom = document.getElementById('custom_date_from').value;
        const dateTo = document.getElementById('custom_date_to').value;
        
        if (!dateFrom || !dateTo) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –æ–±–µ –¥–∞—Ç—ã');
            return;
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ dateFrom –Ω–µ –ø–æ–∑–∂–µ dateTo
        if (new Date(dateFrom) > new Date(dateTo)) {
            alert('–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–∑–∂–µ –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è');
            return;
        }
        
        // –§–æ—Ä–º–∏—Ä—É–µ–º URL —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
        const branchParam = '{{ selected_branch_id|default:"" }}';
        let url = '?custom_date_from=' + dateFrom + '&custom_date_to=' + dateTo;
        
        if (branchParam) {
            url += '&branch=' + branchParam;
        }
        
        window.location.href = url;
    }
    
    function resetPeriod() {
        const branchParam = '{{ selected_branch_id|default:"" }}';
        let url = '?period={{ DEFAULT_PERIOD|default:"30d" }}';
        
        if (branchParam) {
            url += '&branch=' + branchParam;
        }
        
        window.location.href = url;
    }
    
    // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Enter –≤ –ø–æ–ª—è—Ö –¥–∞—Ç
    document.getElementById('custom_date_from').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            applyCustomPeriod();
        }
    });
    
    document.getElementById('custom_date_to').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            applyCustomPeriod();
        }
    });
</script>
{% endblock %}