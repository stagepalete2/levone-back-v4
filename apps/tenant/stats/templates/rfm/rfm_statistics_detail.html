{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block extrastyle %}
{{ block.super }}
<!-- Bootstrap 5.3 CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
<!-- Bootstrap Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
<style>
    #content {
        background: #f4f7f6 !important;
        color: #333 !important;
        min-height: 100vh;
    }

    /* Sidebar & Layout */
    .stats-row {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .stat-card .label {
        color: #888;
        font-size: 13px;
        margin-bottom: 8px;
    }

    .stat-card .value {
        font-size: 32px;
        font-weight: 700;
        color: #1B2838;
    }

    .stat-card .change {
        font-size: 12px;
        margin-top: 5px;
        color: #333;
    }

    .stat-card .change.up {
        color: #27ae60;
    }

    .stat-card .change.down {
        color: #e74c3c;
    }

    /* RF Matrix Container */
    .matrix-container {
        background: white;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        margin-bottom: 30px;
    }

    .matrix-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .matrix-title {
        font-size: 18px;
        font-weight: 600;
        color: #1B2838;
    }

    .matrix-actions {
        display: flex;
        gap: 10px;
    }

    .btn {
        padding: 10px 20px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s;
    }

    .btn-primary {
        background: #C9A227;
        color: white;
    }

    .btn-primary:hover {
        background: #b8931f;
    }

    .btn-secondary {
        background: #f0f0f0;
        color: #333;
    }

    .btn-secondary:hover {
        background: #e0e0e0;
    }

    .btn-danger {
        background: #ffebee;
        color: #c62828;
    }

    .btn-danger:hover {
        background: #ffcdd2;
    }

    /* Matrix Grid System */
    .matrix-grid {
        display: grid;
        grid-template-columns: 120px repeat(3, 1fr);
        gap: 4px;
    }

    .matrix-cell {
        padding: 15px;
        text-align: center;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
        min-height: 110px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .matrix-cell:hover {
        transform: scale(1.02);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        z-index: 10;
    }

    .matrix-header-cell {
        background: #1B2838;
        color: white;
        font-weight: 600;
        font-size: 12px;
        cursor: default;
        min-height: auto;
        padding: 10px;
        display: block;
    }

    .matrix-header-cell:hover {
        transform: none;
        box-shadow: none;
    }

    .matrix-row-header {
        background: #eee;
        font-weight: 600;
        font-size: 11px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        cursor: default;
        text-align: left;
        align-items: flex-start;
        padding-left: 15px;
    }

    .matrix-row-header:hover {
        transform: none;
        box-shadow: none;
    }

    .matrix-row-header .days {
        font-size: 10px;
        color: #666;
        font-weight: 400;
        margin-top: 3px;
    }

    .segment-cell {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
        width: 100%;
    }

    .segment-emoji {
        font-size: 24px;
    }

    .segment-name {
        font-size: 12px;
        font-weight: 600;
        color: #333;
        line-height: 1.2;
    }

    .segment-count {
        font-size: 20px;
        font-weight: 700;
        color: #1B2838;
    }

    .segment-percent {
        font-size: 10px;
        color: #666;
    }

    /* Tooltip & Question Icon */
    .question-icon {
        position: absolute;
        top: 8px;
        right: 8px;
        width: 20px;
        height: 20px;
        background: rgba(255, 255, 255, 0.5);
        border-radius: 50%;
        color: #333;
        font-size: 12px;
        font-weight: 700;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: help;
        transition: all 0.2s;
        z-index: 20;
    }

    .question-icon:hover {
        background: #fff;
        color: #000;
        transform: scale(1.1);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .question-icon .strategy-popup {
        position: absolute;
        bottom: 140%;
        right: -10px;
        width: 220px;
        background: #1B2838;
        color: #fff;
        padding: 12px;
        border-radius: 8px;
        font-size: 11px;
        line-height: 1.4;
        font-weight: 400;
        text-align: left;
        opacity: 0;
        visibility: hidden;
        transform: translateY(10px);
        transition: all 0.2s ease-in-out;
        pointer-events: none;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        z-index: 100;
    }

    .question-icon .strategy-popup::after {
        content: '';
        position: absolute;
        top: 100%;
        right: 15px;
        border: 6px solid transparent;
        border-top-color: #1B2838;
    }

    .question-icon:hover .strategy-popup {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }

    /* Segment Detail Panel */
    .segment-panel {
        background: white;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        display: none;
        margin-bottom: 50px;
    }

    .segment-panel.active {
        display: block;
        animation: fadeIn 0.3s ease-in-out;
    }

    .panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
    }

    .panel-title {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .panel-title .emoji {
        font-size: 36px;
    }

    .panel-title .info h3 {
        font-size: 20px;
        color: #1B2838;
        margin: 0;
    }

    .panel-title .info p {
        color: #666;
        font-size: 14px;
        margin: 0;
    }

    .strategy-box {
        background: #f8f9fa;
        border-left: 4px solid #C9A227;
        padding: 15px 20px;
        border-radius: 0 8px 8px 0;
        margin-bottom: 20px;
    }

    /* Guest Table */
    .table-responsive {
        overflow-x: auto;
    }

    .guest-table {
        width: 100% !important;
        border-collapse: collapse !important;
    }

    .guest-table th {
        background: #f8f9fa !important;
        padding: 12px 15px !important;
        text-align: left !important;
        font-size: 12px !important;
        color: #666 !important;
        text-transform: uppercase !important;
        border-bottom: 2px solid #eee !important;
    }

    .guest-table tr {
        background: #fff !important;
        border-bottom: 1px solid #eee;
    }

    .guest-table td {
        padding: 12px 15px !important;
        font-size: 14px !important;
        color: #333;
    }

    .vk-link {
        color: #4a76a8;
        text-decoration: none;
        font-weight: 500;
    }

    .vk-link:hover {
        text-decoration: underline;
    }

    /* Settings Form */
    .settings-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        margin-top: 20px;
    }

    .setting-group {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
    }

    .setting-group h4 {
        color: #1B2838;
        margin-bottom: 15px;
        font-size: 14px;
        font-weight: 700;
        border-bottom: 1px solid #ddd;
        padding-bottom: 8px;
    }

    .setting-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .setting-row label {
        color: #666;
        font-size: 13px;
    }

    .setting-row input {
        width: 80px;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        text-align: center;
        font-weight: 600;
    }

    /* Export Modal */
    .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .modal-overlay.active {
        display: flex;
    }

    .modal-content {
        background: white;
        border-radius: 12px;
        padding: 30px;
        width: 400px;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="main p-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="page-title mb-0">üéØ RF-–ê–Ω–∞–ª–∏–∑ –≥–æ—Å—Ç–µ–π</h1>
            <p class="text-muted mt-1 mb-0">{{ branch.name }} ‚Ä¢ –û–±–Ω–æ–≤–ª–µ–Ω–æ: {{ last_update|date:"d.m.Y H:i"|default:"–ù–µ–¥–∞–≤–Ω–æ" }}</p>
        </div>
        <input type="hidden" id='branch_id' value='{{ branch.id }}'>
    </div>

    <div class="stats-row">
        <div class="stat-card">
            <div class="label">–í—Å–µ–≥–æ –æ—Ü–∏—Ñ—Ä–æ–≤–∞–Ω–æ</div>
            <div class="value">{{ total_guests }}</div>
            <div class="change up">‚Üë –ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</div>
        </div>
        <div class="stat-card">
            <div class="label">üèÜ VIP-—Å–µ–≥–º–µ–Ω—Ç—ã (F3)</div>
            <div class="value">{{ vip_count }}</div>
            <div class="change">{% widthratio vip_count total_guests 100 %}% –æ—Ç –±–∞–∑—ã</div>
        </div>
        <div class="stat-card">
            <div class="label">‚ö†Ô∏è –ü–æ–¥ —É–≥—Ä–æ–∑–æ–π (R1)</div>
            <div class="value">{{ at_risk_count }}</div>
            <div class="change down">–¢—Ä–µ–±—É—é—Ç –≤–Ω–∏–º–∞–Ω–∏—è</div>
        </div>
        <div class="stat-card">
            <div class="label">üíî –ü–æ—Ç–µ—Ä—è–Ω–Ω—ã–µ (R0)</div>
            <div class="value">{{ lost_count }}</div>
            <div class="change">{% widthratio lost_count total_guests 100 %}% –æ—Ç –±–∞–∑—ã</div>
        </div>
    </div>

    <div class="matrix-container">
        <div class="matrix-header">
            <div class="matrix-title">RF-–ú–∞—Ç—Ä–∏—Ü–∞</div>
            <div class="matrix-actions">
                <button class="btn btn-secondary" onclick="showSettings()">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                <button class="btn btn-primary" onclick="recalculate()">üîÑ –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å</button>
            </div>
        </div>

        <div class="matrix-grid">
            <div class="matrix-cell matrix-header-cell"></div>
            <div class="matrix-cell matrix-header-cell">
                F1: –†–µ–¥–∫–æ<br>
                <small class="opacity-75">({{ f1_range.frequency_min }}-{{ f1_range.frequency_max }} –≤–∏–∑.)</small>
            </div>
            <div class="matrix-cell matrix-header-cell">
                F2: –£–º–µ—Ä–µ–Ω–Ω–æ<br>
                <small class="opacity-75">({{ f2_range.frequency_min }}-{{ f2_range.frequency_max }} –≤–∏–∑.)</small>
            </div>
            <div class="matrix-cell matrix-header-cell">
                F3: –ß–∞—Å—Ç–æ<br>
                <small class="opacity-75">({{ f3_range.frequency_min }}+ –≤–∏–∑.)</small>
            </div>

            {% for segment in segments %}
            {# –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Å—Ç—Ä–æ–∫ R3, R2, R1, R0 #}
            {% if forloop.counter0|divisibleby:3 %}
            <div class="matrix-cell matrix-row-header">
                {% with code=segment.code|slice:":2" %}
                <div style="font-size: 14px; font-weight: 800; color: #1B2838;">
                    {% if code == "R3" %}R3{% elif code == "R2" %}R2{% elif code == "R1" %}R1{% else %}R0{% endif %}
                </div>
                <div class="text-muted small">
                    {% if code == "R3" %}–°–≤–µ–∂–∏–π{% elif code == "R2" %}–¢—ë–ø–ª—ã–π{% elif code == "R1" %}–û—Å—Ç—ã–≤—à–∏–π{% else
                    %}–•–æ–ª–æ–¥–Ω—ã–π{% endif %}
                </div>
                {% endwith %}
                <div class="days">
                    {% if segment.recency_max >= 999 %}
                    > {{ segment.recency_min }} –¥–Ω.
                    {% else %}
                    {{ segment.recency_min }}-{{ segment.recency_max }} –¥–Ω.
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <div class="matrix-cell" style="background-color: {{ segment.color }};"
                onclick="showSegment('{{ segment.code }}')">
                <div class="question-icon" onclick="event.stopPropagation()">?
                    <div class="strategy-popup">
                        <strong>–°—Ç—Ä–∞—Ç–µ–≥–∏—è:</strong><br>
                        {{ segment.strategy|default:"–°—Ç—Ä–∞—Ç–µ–≥–∏—è –Ω–µ –∑–∞–¥–∞–Ω–∞" }}
                    </div>
                </div>
                <div class="segment-cell">
                    <div class="segment-emoji">{{ segment.emoji }}</div>
                    <div class="segment-name">{{ segment.name }}</div>
                    <div class="segment-count">{{ segment.guests_count }}</div>
                    <div class="segment-percent">{% widthratio segment.guests_count total_guests 100 %}%</div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="segment-panel active" id="segmentPanel">
        <div class="panel-header">
            <div class="panel-title">
                <div class="emoji" id="paneEmoji">üèÜ</div>
                <div class="info">
                    <h3 id="paneTitle">–°—É–ø–µ—Ä—Ñ–∞–Ω–∞—Ç—ã (R3F3)</h3>
                    <p id="paneSub">–ì–æ—Å—Ç–µ–π –≤ —Å–µ–≥–º–µ–Ω—Ç–µ: {{ initial_guests|length }}</p>
                </div>
            </div>
            <div class="matrix-actions">
                <button class="btn btn-secondary" onclick="exportSegment()">üì• –í—ã–≥—Ä—É–∑–∏—Ç—å (Senler)</button>
            </div>
        </div>

        <div class="strategy-box">
            <h4>üí° –°—Ç—Ä–∞—Ç–µ–≥–∏—è —Ä–∞–±–æ—Ç—ã</h4>
            <p id="paneStrategy">–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ–≥–º–µ–Ω—Ç –≤ –º–∞—Ç—Ä–∏—Ü–µ –≤—ã—à–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å–ø–∏—Å–æ–∫ –≥–æ—Å—Ç–µ–π –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.</p>
            <p id="paneLastCampaign" style="margin-top: 10px; font-size: 12px; color: #888; display: none;">
                üì® <span id="lastCampaignText">–ü–æ—Å–ª–µ–¥–Ω—è—è —Ä–∞—Å—Å—ã–ª–∫–∞:</span>
            </p>
        </div>

        <div class="table-responsive">
            <table class="guest-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>–ì–æ—Å—Ç—å</th>
                        <th>–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤–∏–∑–∏—Ç</th>
                        <th class="text-center">–í–∏–∑–∏—Ç–æ–≤</th>
                        <th class="text-center">–ö–æ–∏–Ω–æ–≤</th>
                    </tr>
                </thead>
                <tbody id="guestTableBody">
                    {% for score in initial_guests %}
                    <tr>
                        <td><a href="https://vk.com/id{{ score.client.client.vk_user_id }}" target="_blank"
                                class="vk-link">id{{ score.client.client.vk_user_id }}</a></td>
                        <td>{{ score.client.client.full_name }}</td>
                        <td>{{ score.calculated_at|date:"d.m.Y" }}</td>
                        <td class="text-center">{{ score.frequency }}</td>
                        <td class="text-center">{{ score.client.coins_balance }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center py-4 text-muted">–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ–≥–º–µ–Ω—Ç –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="segment-panel" id="settingsPanel">
        <form id="settingsForm">
            <div class="panel-header">
                <div class="panel-title">
                    <div class="emoji">‚öôÔ∏è</div>
                    <div class="info">
                        <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ—Ä–æ–≥–æ–≤ RF</h3>
                        <p>–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –≥—Ä–∞–Ω–∏—Ü—ã –¥–∞–≤–Ω–æ—Å—Ç–∏ –∏ —á–∞—Å—Ç–æ—Ç—ã –ø–æ–¥ –≤–∞—à—É –±–∏–∑–Ω–µ—Å-–º–æ–¥–µ–ª—å</p>
                    </div>
                </div>
                <div class="matrix-actions">
                    <button type="button" class="btn btn-secondary" onclick="resetSettings()">‚Ü©Ô∏è –°–±—Ä–æ—Å–∏—Ç—å</button>
                    <button type="submit" class="btn btn-primary">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button type="button" class="btn btn-danger" onclick="closeSettings()">‚ùå –û—Ç–º–µ–Ω–∞</button>
                </div>
            </div>

            <div class="settings-grid">
                <div class="setting-group">
                    <h4>Recency (–î–Ω–∏ —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤–∏–∑–∏—Ç–∞)</h4>
                    <div class="setting-row">
                        <label>R3 ¬´–°–≤–µ–∂–∏–π¬ª (0 - X –¥–Ω–µ–π)</label>
                        <input type="number" name="r3_max" value="{{ r3_range.recency_max|default:14 }}">
                    </div>
                    <div class="setting-row">
                        <label>R2 ¬´–¢—ë–ø–ª—ã–π¬ª (R3 - X –¥–Ω–µ–π)</label>
                        <input type="number" name="r2_max" value="{{ r2_range.recency_max|default:30 }}">
                    </div>
                    <div class="setting-row">
                        <label>R1 ¬´–û—Å—Ç—ã–≤—à–∏–π¬ª (R2 - X –¥–Ω–µ–π)</label>
                        <input type="number" name="r1_max" value="{{ r1_range.recency_max }}">
                    </div>
                    <div class="setting-row">
                        <label>R0 ¬´–•–æ–ª–æ–¥–Ω—ã–π¬ª (–±–æ–ª–µ–µ R1)</label>
                        <input type="text" value="‚àû" disabled style="background: #eee;">
                    </div>
                </div>

                <div class="setting-group">
                    <h4>Frequency (–ö–æ–ª-–≤–æ –≤–∏–∑–∏—Ç–æ–≤)</h4>
                    <div class="setting-row">
                        <label>F1 ¬´–†–µ–¥–∫–æ¬ª (1 - X –≤–∏–∑–∏—Ç–æ–≤)</label>
                        <input type="number" name="f1_max" value="{{ f1_range.frequency_max|default:2 }}">
                    </div>
                    <div class="setting-row">
                        <label>F2 ¬´–£–º–µ—Ä–µ–Ω–Ω–æ¬ª (F1 - X –≤–∏–∑–∏—Ç–æ–≤)</label>
                        <input type="number" name="f2_max" value="{{ f2_range.frequency_max|default:5 }}">
                    </div>
                    <div class="setting-row">
                        <label>F3 ¬´–ß–∞—Å—Ç–æ¬ª (–±–æ–ª–µ–µ F2)</label>
                        <input type="text" value="‚àû" disabled style="background: #eee;">
                    </div>
                    <div class="mt-4 pt-3 border-top">
                        <div class="setting-row">
                            <label class="fw-bold text-dark">–ü–µ—Ä–∏–æ–¥ –∞–Ω–∞–ª–∏–∑–∞ (–¥–Ω–µ–π):</label>
                            <input type="number" name="analysis_period"
                                value="{{ settings.analysis_period|default:365 }}" style="width: 100px;">
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="modal-overlay" id="exportModal">
    <div class="modal-content">
        <h3 class="h5 fw-bold mb-3">üì• –í—ã–≥—Ä—É–∑–∫–∞ –¥–ª—è Senler</h3>
        <p class="text-muted small mb-3">
            –ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω —Ñ–∞–π–ª <b>.txt</b> —Å–æ —Å–ø–∏—Å–∫–æ–º VK ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å–µ–≥–º–µ–Ω—Ç–∞ <span id='exportSegmentName'
                class="fw-bold"></span>.
            <br>–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: <span id='exportCount' class="text-success fw-bold"></span>.
        </p>
        <div id='exportPreview' class="bg-light p-3 rounded mb-3 font-monospace small text-muted">Loading...</div>
        <div class="d-flex justify-content-end gap-2">
            <button class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn btn-primary" onclick="downloadFile()">‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª</button>
        </div>
    </div>
</div>

<script>
    // State management
    let currentSegmentData = { name: '', code: '', ids: [] };
    const BASE_URL = window.location.origin;

    // --- Panel Toggle Logic ---
    function showSettings() {
        document.getElementById('settingsPanel').classList.add('active');
        document.getElementById('segmentPanel').classList.remove('active');
    }

    function closeSettings() {
        document.getElementById('settingsPanel').classList.remove('active');
        document.getElementById('segmentPanel').classList.add('active');
    }

    // --- API Interactions ---

    function showSegment(code) {
        closeSettings(); // Ensure we see the segment panel
        const branch = document.getElementById('branch_id').value;
        const tbody = document.getElementById('guestTableBody');

        // Loader
        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4"><div class="spinner-border text-primary" role="status"></div><div class="mt-2 text-muted">–ó–∞–≥—Ä—É–∑–∫–∞ –≥–æ—Å—Ç–µ–π...</div></td></tr>';

        // URL construction using Django pattern requires a placeholder replacement or a clean JS URL build
        // Assuming we have a URL pattern like /api/rf/segments/<code:segment_code>/
        // Using a safe trick with template literal in JS if endpoint is fixed
        const fetchUrl = `/analytics/api/v1/rf/segment-guest/${code}/?branch=${branch}`;

        fetch(fetchUrl)
            .then(res => {
                if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
                return res.json();
            })
            .then(data => {
                // Update UI Headers
                currentSegmentData = {
                    name: data.segment_name,
                    code: code,
                    ids: data.guests.map(g => g.vk_id)
                };

                document.getElementById('paneTitle').innerText = `${data.segment_name} (${code})`;
                document.getElementById('paneEmoji').innerText = data.segment_emoji;
                document.getElementById('paneStrategy').innerText = data.strategy || "–î–ª—è –¥–∞–Ω–Ω–æ–≥–æ —Å–µ–≥–º–µ–Ω—Ç–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –ø–æ–∫–∞ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞.";
                document.getElementById('paneSub').innerText = `–ì–æ—Å—Ç–µ–π –≤ —Å–µ–≥–º–µ–Ω—Ç–µ: ${data.count}`;

                // Show last campaign info if available
                const lastCampaignEl = document.getElementById('paneLastCampaign');
                const lastCampaignText = document.getElementById('lastCampaignText');
                if (data.last_campaign) {
                    lastCampaignText.innerText = `–ü–æ—Å–ª–µ–¥–Ω—è—è —Ä–∞—Å—Å—ã–ª–∫–∞: ${data.last_campaign}`;
                    lastCampaignEl.style.display = 'block';
                } else {
                    lastCampaignText.innerText = '–†–∞—Å—Å—ã–ª–æ–∫ –Ω–µ –±—ã–ª–æ';
                    lastCampaignEl.style.display = 'block';
                }

                // Update Table
                tbody.innerHTML = '';
                if (data.guests.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-muted">–í —ç—Ç–æ–º —Å–µ–≥–º–µ–Ω—Ç–µ –ø–æ–∫–∞ –Ω–µ—Ç –≥–æ—Å—Ç–µ–π.</td></tr>';
                    return;
                }

                // Render rows (Limit to first 50 for performance if list is huge, or add pagination later)
                data.guests.forEach(guest => {
                    const row = `
                        <tr>
                            <td><a href="https://vk.com/id${guest.vk_id}" target="_blank" class="vk-link">id${guest.vk_id}</a></td>
                            <td>${guest.name}</td>
                            <td>${guest.last_visit}</td>
                            <td class="text-center">${guest.total_visits}</td>
                            <td class="text-center">${guest.coins}</td>
                        </tr>`;
                    tbody.insertAdjacentHTML('beforeend', row);
                });
            })
            .catch(err => {
                console.error(err);
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.</td></tr>';
            });
    }

    function recalculate() {
        const branch = document.getElementById('branch_id').value;
        if (!confirm('–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–µ—Ä–µ—Å—á–µ—Ç –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π –¥–ª—è –≤—Å–µ—Ö –≥–æ—Å—Ç–µ–π? –≠—Ç–æ –∑–∞–π–º–µ—Ç –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è.')) return;

        const btn = document.querySelector('button[onclick="recalculate()"]');
        const oldText = btn.innerHTML;
        btn.innerHTML = '‚è≥...';
        btn.disabled = true;

        fetch("{% url 'rf-recalculate' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ branch: parseInt(branch) })
        })
            .then(res => res.json())
            .then(data => {
                alert(data.message || '–ü—Ä–æ—Ü–µ—Å—Å –∑–∞–ø—É—â–µ–Ω');
                window.location.reload();
            })
            .catch(err => alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø–µ—Ä–µ—Å—á–µ—Ç–∞'))
            .finally(() => {
                btn.innerHTML = oldText;
                btn.disabled = false;
            });
    }

    // --- Settings Form Submission ---
    document.getElementById('settingsForm').onsubmit = function (e) {
        e.preventDefault();

        const branch = document.getElementById('branch_id').value;
        const btn = this.querySelector('button[type="submit"]');

        // Collect data manually to ensure types
        const payload = {
            branch: parseInt(branch),
            r3_max: parseInt(this.querySelector('[name="r3_max"]').value),
            r2_max: parseInt(this.querySelector('[name="r2_max"]').value),
            r1_max: parseInt(this.querySelector('[name="r1_max"]').value),
            f1_max: parseInt(this.querySelector('[name="f1_max"]').value),
            f2_max: parseInt(this.querySelector('[name="f2_max"]').value),
            analysis_period: parseInt(this.querySelector('[name="analysis_period"]').value)
        };

        // Basic Client-side Validation
        if (payload.r3_max >= payload.r2_max || payload.r2_max >= payload.r1_max) {
            alert('–û—à–∏–±–∫–∞: –ì—Ä–∞–Ω–∏—Ü—ã Recency –¥–æ–ª–∂–Ω—ã –≤–æ–∑—Ä–∞—Å—Ç–∞—Ç—å (R3 < R2 < R1)');
            return;
        }

        btn.disabled = true;
        btn.innerHTML = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';

        fetch("{% url 'rf-settings-save' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(payload)
        })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã. –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø–µ—Ä–µ—Å—á–µ—Ç...');
                    recalculate(); // Auto trigger recalculation logic reuse
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + data.message);
                    btn.disabled = false;
                    btn.innerHTML = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
                }
            })
            .catch(err => {
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                btn.disabled = false;
                btn.innerHTML = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
            });
    };

    function resetSettings() {
        if (!confirm('–°–±—Ä–æ—Å–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫ –∑–Ω–∞—á–µ–Ω–∏—è–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é?')) return;
        const form = document.getElementById('settingsForm');
        form.querySelector('[name="r3_max"]').value = 14;
        form.querySelector('[name="r2_max"]').value = 30;
        form.querySelector('[name="r1_max"]').value = 60;
        form.querySelector('[name="f1_max"]').value = 2;
        form.querySelector('[name="f2_max"]').value = 5;
        form.querySelector('[name="analysis_period"]').value = 365;
    }

    // --- Export Logic ---
    function exportSegment() {
        if (currentSegmentData.ids.length === 0) {
            alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—ã–≥—Ä—É–∑–∫–∏');
            return;
        }
        document.getElementById('exportSegmentName').innerText = currentSegmentData.name;
        document.getElementById('exportCount').innerText = currentSegmentData.ids.length;
        document.getElementById('exportPreview').innerText = currentSegmentData.ids.slice(0, 5).join('\n') + (currentSegmentData.ids.length > 5 ? '\n...' : '');
        document.getElementById('exportModal').classList.add('active');
    }

    function closeModal() {
        document.getElementById('exportModal').classList.remove('active');
    }

    function downloadFile() {
        const content = currentSegmentData.ids.join('\n');
        const blob = new Blob([content], { type: 'text/plain' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `rf_export_${currentSegmentData.code}_${new Date().toISOString().slice(0, 10)}.txt`;
        link.click();
        closeModal();
    }
</script>
{% endblock %}