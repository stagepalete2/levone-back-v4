{% extends "admin/base_site.html" %}
{% load i18n %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div style="max-width: 680px;">
    <h1 style="margin-bottom: 6px;">{{ title }}</h1>

    {% if is_bulk %}
        <p style="color: var(--body-quiet-color); margin-bottom: 20px;">
            –ü—Ä–∏–∑—ã –¥–ª—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è:
            {% for p in products %}
                <strong>{{ p.name }}</strong>{% if not forloop.last %}, {% endif %}
            {% endfor %}
        </p>
    {% else %}
        <p style="color: var(--body-quiet-color); margin-bottom: 20px;">
            –¢–µ–∫—É—â–∏–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω: <strong>{{ original.branch }}</strong>
        </p>
    {% endif %}

    <form method="post">
        {% csrf_token %}

        {% if is_bulk %}
            {% for pid in product_ids %}
                <input type="hidden" name="{{ action_checkbox_name }}" value="{{ pid }}">
            {% endfor %}
            <input type="hidden" name="action" value="action_duplicate_to_branches">
        {% endif %}

        <div class="module" style="margin-bottom: 20px; border: 1px solid var(--border-color); border-radius: 4px; overflow: hidden;">

            {# ‚îÄ‚îÄ –®–∞–ø–∫–∞ —Å –∫–Ω–æ–ø–∫–∞–º–∏ –±—ã—Å—Ç—Ä–æ–≥–æ –≤—ã–±–æ—Ä–∞ ‚îÄ‚îÄ #}
            <div style="
                background: var(--darkened-bg);
                padding: 12px 16px;
                border-bottom: 1px solid var(--border-color);
                display: flex;
                align-items: center;
                gap: 10px;
            ">
                <strong style="flex: 1;">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã</strong>
                <button type="button" id="btn-select-all"
                    onclick="toggleAll(true)"
                    style="padding: 4px 12px; border: 1px solid var(--border-color); border-radius: 3px;
                           background: var(--button-bg, #417690); color: #fff; cursor: pointer; font-size: 13px;">
                    ‚úÖ –í—ã–±—Ä–∞—Ç—å –≤—Å–µ
                </button>
                <button type="button" id="btn-deselect-all"
                    onclick="toggleAll(false)"
                    style="padding: 4px 12px; border: 1px solid var(--border-color); border-radius: 3px;
                           background: transparent; color: var(--body-fg); cursor: pointer; font-size: 13px;">
                    ‚úñ –°–Ω—è—Ç—å –≤—Å–µ
                </button>
            </div>

            {# ‚îÄ‚îÄ –°–ø–∏—Å–æ–∫ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤ ‚îÄ‚îÄ #}
            {% if branches_info %}
                <ul style="margin: 0; padding: 0; list-style: none;">
                    {% for item in branches_info %}
                    <li style="
                        padding: 10px 16px;
                        border-bottom: 1px solid var(--border-color);
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        {% if item.already_exists %}opacity: 0.55;{% endif %}
                    ">
                        <input
                            type="checkbox"
                            name="branch_ids"
                            value="{{ item.branch.pk }}"
                            id="branch_{{ item.branch.pk }}"
                            class="branch-checkbox"
                            {% if item.already_exists %}
                                {% comment %}–æ—Å—Ç–∞–≤–ª—è–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–º ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∑–∞—Ö–æ—Ç–µ—Ç—å –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å{% endcomment %}
                            {% endif %}
                            style="width: 17px; height: 17px; cursor: pointer;"
                        >
                        <label for="branch_{{ item.branch.pk }}" style="cursor: pointer; flex: 1; margin: 0;">
                            {{ item.branch.name }}
                        </label>
                        {% if item.already_exists %}
                            <span style="
                                font-size: 11px;
                                padding: 2px 8px;
                                border-radius: 10px;
                                background: rgba(255,193,7,0.2);
                                color: #b38600;
                                border: 1px solid rgba(255,193,7,0.4);
                                white-space: nowrap;
                            ">—É–∂–µ –µ—Å—Ç—å</span>
                        {% endif %}
                    </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p style="padding: 20px 16px; color: var(--body-quiet-color);">
                    –î—Ä—É–≥–∏—Ö —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤ –Ω–µ—Ç ‚Äî –Ω–µ–∫—É–¥–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å.
                </p>
            {% endif %}
        </div>

        {# ‚îÄ‚îÄ –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π ‚îÄ‚îÄ #}
        <div style="display: flex; gap: 10px; align-items: center;">
            <input type="submit" value="üìã –î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –≤ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ"
                style="padding: 10px 20px; background: #417690; color: #fff;
                       border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">
            <a href="{% if is_bulk %}../{% else %}../../{% endif %}"
               style="padding: 10px 16px; color: var(--body-quiet-color); text-decoration: none; font-size: 14px;">
                –û—Ç–º–µ–Ω–∞
            </a>
        </div>
    </form>
</div>

<script>
function toggleAll(check) {
    document.querySelectorAll('.branch-checkbox').forEach(function(cb) {
        cb.checked = check;
    });
}
</script>
{% endblock %}
