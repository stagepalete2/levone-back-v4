{% extends "admin/change_form.html" %}
{% load i18n %}

{% block after_field_sets %}
    {{ block.super }}

    {# ‚îÄ‚îÄ –ú—É–ª—å—Ç–∏–≤—ã–±–æ—Ä —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤ –ø—Ä–∏ –î–û–ë–ê–í–õ–ï–ù–ò–ò –Ω–æ–≤–æ–≥–æ –ø—Ä–∏–∑–∞ ‚îÄ‚îÄ #}
    {% if not original and all_branches_for_add %}
    <fieldset class="module aligned">
        <h2 style="padding: 8px 12px; margin: 0; background: var(--darkened-bg); border-bottom: 1px solid var(--border-color);">
            üìã –¢–∞–∫–∂–µ –¥–æ–±–∞–≤–∏—Ç—å –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã
        </h2>
        <div style="padding: 12px 16px;">
            <p style="margin: 0 0 10px; color: var(--body-quiet-color); font-size: 13px;">
                –ü—Ä–∏–∑ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –¥–ª—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞, –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≤ –ø–æ–ª–µ ¬´–†–µ—Å—Ç–æ—Ä–∞–Ω¬ª –≤—ã—à–µ.
                –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –æ—Ç–º–µ—Ç—å—Ç–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã ‚Äî –∏ –∫–æ–ø–∏–∏ –±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
            </p>

            <div style="margin-bottom: 10px; display: flex; gap: 8px;">
                <button type="button" onclick="toggleExtraBranches(true)"
                    style="padding: 4px 12px; border: 1px solid var(--border-color); border-radius: 3px;
                           background: #417690; color: #fff; cursor: pointer; font-size: 12px;">
                    ‚úÖ –í—ã–±—Ä–∞—Ç—å –≤—Å–µ
                </button>
                <button type="button" onclick="toggleExtraBranches(false)"
                    style="padding: 4px 12px; border: 1px solid var(--border-color); border-radius: 3px;
                           background: transparent; color: var(--body-fg); cursor: pointer; font-size: 12px;">
                    ‚úñ –°–Ω—è—Ç—å –≤—Å–µ
                </button>
            </div>

            <ul style="margin: 0; padding: 0; list-style: none; border: 1px solid var(--border-color); border-radius: 4px; overflow: hidden;">
                {% for branch in all_branches_for_add %}
                <li style="padding: 8px 14px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; gap: 10px;">
                    <input
                        type="checkbox"
                        name="extra_branch_ids"
                        value="{{ branch.pk }}"
                        id="extra_branch_{{ branch.pk }}"
                        class="extra-branch-checkbox"
                        style="width: 16px; height: 16px; cursor: pointer;"
                    >
                    <label for="extra_branch_{{ branch.pk }}" style="cursor: pointer; margin: 0; flex: 1;">
                        {{ branch.name }}
                    </label>
                </li>
                {% endfor %}
            </ul>
        </div>
    </fieldset>

    <script>
    function toggleExtraBranches(check) {
        document.querySelectorAll('.extra-branch-checkbox').forEach(function(cb) {
            cb.checked = check;
        });
    }

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫–ª—é—á–∞–µ–º –≥–∞–ª–æ—á–∫—É —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞, –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≤ –ø–æ–ª–µ ¬´–†–µ—Å—Ç–æ—Ä–∞–Ω¬ª
    document.addEventListener('DOMContentLoaded', function() {
        var branchSelect = document.getElementById('id_branch');
        if (!branchSelect) return;

        function syncBranchCheckbox() {
            var selectedVal = branchSelect.value;
            document.querySelectorAll('.extra-branch-checkbox').forEach(function(cb) {
                var li = cb.closest('li');
                if (cb.value === selectedVal) {
                    cb.checked = false;
                    cb.disabled = true;
                    li.style.opacity = '0.4';
                } else {
                    cb.disabled = false;
                    li.style.opacity = '';
                }
            });
        }

        branchSelect.addEventListener('change', syncBranchCheckbox);
        syncBranchCheckbox();
    });
    </script>
    {% endif %}
{% endblock %}

{% block submit_buttons_bottom %}
    {{ block.super }}
    {% if show_duplicate_btn and original %}
    <div class="submit-row" style="margin-top: 8px;">
        <a href="{{ duplicate_url }}"
           class="button"
           style="background: #417690; color: #fff; padding: 10px 16px;
                  border-radius: 4px; text-decoration: none; display: inline-block; font-size: 13px;">
            üìã –î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã‚Ä¶
        </a>
    </div>
    {% endif %}
{% endblock %}
