{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block extrastyle %}
    {{ block.super }}
    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <style>
        #content {
            background: #f4f7f6 !important;
            color: #333 !important;
            min-height: 100vh;
            padding: 20px !important;
        }
        
        /* Fix for Admin Sidebar when Bootstrap is loaded */
        #nav-sidebar, #nav-sidebar * {
            box-sizing: content-box !important;
        }
        #nav-sidebar ul {
            padding-left: 0;
            margin-bottom: 0;
            list-style: none;
        }
        #nav-sidebar li {
            list-style: none;
        }
        #header, #header * {
             box-sizing: content-box !important;
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .stat-card .label {
            color: #888;
            font-size: 13px;
            margin-bottom: 8px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: 700;
            color: #1B2838;
        }

        .stat-card .change {
            font-size: 12px;
            margin-top: 5px;
            color: #333;
        }

        .stat-card .change.up { color: #27ae60; }
        .stat-card .change.down { color: #e74c3c; }

        .matrix-container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
        }

        .matrix-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .matrix-title {
            font-size: 18px;
            font-weight: 600;
            color: #1B2838;
        }

        .matrix-grid {
            display: grid;
            grid-template-columns: 120px repeat(3, 1fr);
            gap: 4px;
        }

        .matrix-cell {
            padding: 15px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            min-height: 110px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .matrix-cell:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            z-index: 10;
        }

        .matrix-header-cell {
            background: #1B2838;
            color: white;
            font-weight: 600;
            font-size: 12px;
            cursor: default;
            min-height: auto;
            padding: 10px;
            display: block;
        }

        .matrix-header-cell:hover {
            transform: none;
            box-shadow: none;
        }

        .matrix-row-header {
            background: #eee;
            font-weight: 600;
            font-size: 11px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            cursor: default;
            text-align: left;
            align-items: flex-start;
            padding-left: 15px;
        }

        .matrix-row-header:hover {
            transform: none;
            box-shadow: none;
        }

        .matrix-row-header .days {
            font-size: 10px;
            color: #666;
            font-weight: 400;
            margin-top: 3px;
        }

        .segment-cell {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            width: 100%;
        }

        .segment-emoji { font-size: 24px; }
        .segment-name { font-size: 12px; font-weight: 600; color: #333; line-height: 1.2; }
        .segment-count { font-size: 20px; font-weight: 700; color: #1B2838; }
        .segment-percent { font-size: 10px; color: #666; }

        .question-icon {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 20px;
            height: 20px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            color: #333;
            font-size: 12px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: help;
            z-index: 20;
        }

        .question-icon:hover { background: #fff; }

        .question-icon .strategy-popup {
            position: absolute;
            bottom: 140%;
            right: -10px;
            width: 220px;
            background: #1B2838;
            color: #fff;
            padding: 12px;
            border-radius: 8px;
            font-size: 11px;
            line-height: 1.4;
            font-weight: 400;
            text-align: left;
            opacity: 0;
            visibility: hidden;
            z-index: 100;
        }

        .question-icon:hover .strategy-popup {
            opacity: 1;
            visibility: visible;
        }
    </style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 fw-bold mb-1">üì¶ RF-–ê–Ω–∞–ª–∏–∑ –¥–æ—Å—Ç–∞–≤–∫–∏</h1>
            <p class="text-muted mt-1 mb-0">–û–±–Ω–æ–≤–ª–µ–Ω–æ: {{ last_update|date:"d.m.Y H:i"|default:"–ù–µ–¥–∞–≤–Ω–æ" }}</p>
        </div>
        <a href="{% url 'delivery-rf-migration' %}" class="btn btn-success">
            <i class="bi bi-clock-history me-2"></i>–ò—Å—Ç–æ—Ä–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏
        </a>
    </div>

    <div class="stats-row">
        <div class="stat-card">
            <div class="label">–í—Å–µ–≥–æ –∞–∫—Ç–∏–≤–∞—Ü–∏–π</div>
            <div class="value">{{ total_activations }}</div>
            <div class="change up">QR-–∫–æ–¥–æ–≤ –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ</div>
        </div>
        <div class="stat-card">
            <div class="label">–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤</div>
            <div class="value">{{ unique_clients }}</div>
            <div class="change">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –¥–æ—Å—Ç–∞–≤–∫—É</div>
        </div>
        <div class="stat-card">
            <div class="label">üèÜ VIP-—Å–µ–≥–º–µ–Ω—Ç—ã (F3)</div>
            <div class="value">{{ vip_count }}</div>
            <div class="change">–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–∫—É–ø–∞—Ç–µ–ª–∏</div>
        </div>
        <div class="stat-card">
            <div class="label">üíî –ü–æ—Ç–µ—Ä—è–Ω–Ω—ã–µ (R0)</div>
            <div class="value">{{ lost_count }}</div>
            <div class="change down">–¢—Ä–µ–±—É—é—Ç —Ä–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏</div>
        </div>
    </div>

    <div class="matrix-container">
        <div class="matrix-header">
            <div class="matrix-title">RF-–ú–∞—Ç—Ä–∏—Ü–∞ –¥–æ—Å—Ç–∞–≤–∫–∏</div>
        </div>

        <div class="matrix-grid">
            <div class="matrix-cell matrix-header-cell"></div>
            <div class="matrix-cell matrix-header-cell">
                F1: –†–µ–¥–∫–æ<br>
                <small class="opacity-75">({{ f1_range.frequency_min|default:1 }}-{{ f1_range.frequency_max|default:2 }} –∞–∫—Ç.)</small>
            </div>
            <div class="matrix-cell matrix-header-cell">
                F2: –£–º–µ—Ä–µ–Ω–Ω–æ<br>
                <small class="opacity-75">({{ f2_range.frequency_min|default:3 }}-{{ f2_range.frequency_max|default:5 }} –∞–∫—Ç.)</small>
            </div>
            <div class="matrix-cell matrix-header-cell">
                F3: –ß–∞—Å—Ç–æ<br>
                <small class="opacity-75">({{ f3_range.frequency_min|default:6 }}+ –∞–∫—Ç.)</small>
            </div>

            {% for segment in segments %}
            {% if forloop.counter0|divisibleby:3 %}
            <div class="matrix-cell matrix-row-header">
                {% with code=segment.code|slice:":2" %}
                <div style="font-size: 14px; font-weight: 800; color: #1B2838;">
                    {% if code == "R3" %}R3{% elif code == "R2" %}R2{% elif code == "R1" %}R1{% else %}R0{% endif %}
                </div>
                <div class="text-muted small">
                    {% if code == "R3" %}–°–≤–µ–∂–∏–π{% elif code == "R2" %}–¢—ë–ø–ª—ã–π{% elif code == "R1" %}–û—Å—Ç—ã–≤—à–∏–π{% else %}–•–æ–ª–æ–¥–Ω—ã–π{% endif %}
                </div>
                {% endwith %}
                <div class="days">
                    {% if segment.recency_max >= 999 %}
                    > {{ segment.recency_min }} –¥–Ω.
                    {% else %}
                    {{ segment.recency_min }}-{{ segment.recency_max }} –¥–Ω.
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <div class="matrix-cell" style="background-color: {{ segment.color }};">
                <div class="question-icon" onclick="event.stopPropagation()">?
                    <div class="strategy-popup">
                        <strong>–°—Ç—Ä–∞—Ç–µ–≥–∏—è:</strong><br>
                        {{ segment.strategy|default:"–°—Ç—Ä–∞—Ç–µ–≥–∏—è –Ω–µ –∑–∞–¥–∞–Ω–∞" }}
                    </div>
                </div>
                <div class="segment-cell">
                    <div class="segment-emoji">{{ segment.emoji }}</div>
                    <div class="segment-name">{{ segment.name }}</div>
                    <div class="segment-count">{{ segment.guests_count }}</div>
                    {% if unique_clients > 0 %}
                    <div class="segment-percent">{% widthratio segment.guests_count unique_clients 100 %}%</div>
                    {% else %}
                    <div class="segment-percent">0%</div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}
