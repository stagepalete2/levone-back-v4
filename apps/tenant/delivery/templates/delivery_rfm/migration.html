{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block extrastyle %}
{{ block.super }}
<!-- Bootstrap 5.3 CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
<!-- Bootstrap Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
<style>
    .migration-wrapper { padding: 30px; max-width: 1400px; margin: 0 auto; font-family: 'Inter', system-ui, sans-serif; }
    
    .content-card { 
        background: white; border-radius: 12px; border: 1px solid #e0e0e0; 
        box-shadow: 0 4px 6px rgba(0,0,0,0.03); padding: 25px; margin-bottom: 30px; 
    }
    
    .sankey-area { 
        background: #fff; min-height: 300px; display: flex; 
        align-items: center; justify-content: center; 
    }
    
    .kpi-box { padding: 20px; border-radius: 10px; text-align: center; height: 100%; }
    .kpi-val { font-size: 2rem; font-weight: 800; line-height: 1.2; }
    .kpi-label { text-transform: uppercase; font-size: 0.7rem; letter-spacing: 1px; margin-bottom: 8px; }
</style>
{% endblock %}

{% block content %}
<div class="migration-wrapper">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 fw-bold mb-1">üìà –ò—Å—Ç–æ—Ä–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏ (–î–æ—Å—Ç–∞–≤–∫–∞)</h1>
            <p class="text-muted mb-0">–ê–Ω–∞–ª–∏–∑ –∞–∫—Ç–∏–≤–∞—Ü–∏–π QR-–∫–æ–¥–æ–≤</p>
        </div>
        
        <div class="d-flex gap-3">
            <a href="{% url 'delivery-rf-statistics' %}" class="btn btn-outline-secondary">
                <i class="bi bi-grid-3x3 me-2"></i>–ú–∞—Ç—Ä–∏—Ü–∞ RF
            </a>
            <form method="GET" class="d-flex gap-3 bg-white p-2 rounded border shadow-sm">
                <select name="days" class="form-select border-0 bg-light fw-bold" style="width: 160px;">
                    <option value="7" {% if days == 7 %}selected{% endif %}>7 –¥–Ω–µ–π</option>
                    <option value="14" {% if days == 14 %}selected{% endif %}>14 –¥–Ω–µ–π</option>
                    <option value="30" {% if days == 30 %}selected{% endif %}>30 –¥–Ω–µ–π</option>
                    <option value="90" {% if days == 90 %}selected{% endif %}>90 –¥–Ω–µ–π</option>
                </select>
                
                <select name="segment" class="form-select border-0 bg-light fw-bold" style="width: 200px;">
                    <option value="">–í—Å–µ —Å–µ–≥–º–µ–Ω—Ç—ã</option>
                    {% for seg in all_segments %}
                        <option value="{{ seg.code }}" {% if selected_segment == seg.code %}selected{% endif %}>
                            {{ seg.emoji }} {{ seg.name }}
                        </option>
                    {% endfor %}
                </select>
                
                <button type="submit" class="btn btn-dark rounded px-3">–û–±–Ω–æ–≤–∏—Ç—å</button>
            </form>
        </div>
    </div>

    <div class="content-card">
        <h5 class="fw-bold mb-4">–ü–æ—Ç–æ–∫–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–π</h5>
        <div id="sankey_chart" class="sankey-area">
            <div class="spinner-border text-secondary" role="status"></div>
        </div>
    </div>

    <div class="content-card">
        <h5 class="fw-bold mb-4">–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∑–∞ –ø–µ—Ä–∏–æ–¥</h5>
        <div class="row g-3">
            <div class="col-md">
                <div class="kpi-box" style="background: #f0fff4; color: #166534;">
                    <div class="kpi-label">–ù–æ–≤—ã–µ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏</div>
                    <div class="kpi-val">+{{ growth_count }}</div>
                </div>
            </div>
            <div class="col-md">
                <div class="kpi-box" style="background: #fff7ed; color: #9a3412;">
                    <div class="kpi-label">–û—Å—Ç—ã–≤–∞–Ω–∏–µ</div>
                    <div class="kpi-val">{{ natural_cooling_count }}</div>
                </div>
            </div>
            <div class="col-md">
                <div class="kpi-box" style="background: #fef2f2; color: #991b1b;">
                    <div class="kpi-label">–û—Ç—Ç–æ–∫ –≤ R0</div>
                    <div class="kpi-val">{{ real_churn_count }}</div>
                </div>
            </div>
            <div class="col-md">
                <div class="kpi-box" style="background: #eff6ff; color: #1e40af;">
                    <div class="kpi-label">–†–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è</div>
                    <div class="kpi-val">{{ reactivation_count }}</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript">
    google.charts.load('current', {'packages':['sankey']});
    google.charts.setOnLoadCallback(drawChart);

    function drawChart() {
        const container = document.getElementById('sankey_chart');
        const rawData = {{ sankey_data|safe }};

        if (!rawData || rawData.length === 0) {
            container.innerHTML = '<div class="text-center text-muted py-5">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –¥–∏–∞–≥—Ä–∞–º–º—ã –∑–∞ —ç—Ç–æ—Ç –ø–µ—Ä–∏–æ–¥</div>';
            return;
        }

        var data = new google.visualization.DataTable();
        data.addColumn('string', 'From');
        data.addColumn('string', 'To');
        data.addColumn('number', 'Count');
        data.addRows(rawData);

        var options = {
            width: '100%',
            height: 300,
            sankey: {
                node: { 
                    label: { fontName: 'Inter', fontSize: 12, bold: true, color: '#333' },
                    nodePadding: 20,
                    width: 12
                },
                link: { colorMode: 'gradient', fillOpacity: 0.2 }
            }
        };

        var chart = new google.visualization.Sankey(container);
        chart.draw(data, options);
    }
</script>
{% endblock %}
