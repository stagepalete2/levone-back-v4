{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block extrastyle %}
{{ block.super }}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
<style>
    #container,#header,#nav-sidebar,#header *,#nav-sidebar *{box-sizing:content-box!important}
    #nav-sidebar{position:sticky!important;top:0!important;max-height:100vh!important;overflow-x:hidden!important;overflow-y:auto!important;width:275px!important;flex-shrink:0!important}
    #nav-sidebar ul{padding-left:0;margin-bottom:0;list-style:none} #nav-sidebar li{list-style:none}
    #main,#content,#content *{box-sizing:border-box!important}
    #content{background:#f4f7f6!important;color:#333!important;min-height:100vh}

    .migration-wrapper { padding: 30px; max-width: 1400px; margin: 0 auto; font-family: 'Inter', system-ui, sans-serif; }

    .mode-tabs { display:inline-flex; gap:0; background:#fff; border:2px solid #e0e0e0; border-radius:12px; overflow:hidden; margin-bottom:20px; box-shadow:0 2px 6px rgba(0,0,0,0.05); }
    .mode-tab { padding:12px 28px; font-size:0.9rem; font-weight:700; color:#666; text-decoration:none!important; transition:all 0.15s; border-right:2px solid #e0e0e0; text-align:center; }
    .mode-tab:last-child { border-right:none; }
    .mode-tab:hover { background:#f8f8f8; }
    .mode-tab.active { background:#1B2838; color:#fff; }
    .mode-tab small { display:block; font-size:0.68rem; font-weight:500; margin-top:2px; color:inherit; opacity:0.7; }

    .content-card { background:white; border-radius:12px; border:1px solid #e0e0e0; box-shadow:0 4px 6px rgba(0,0,0,0.03); padding:25px; margin-bottom:30px; }
    .sankey-area { background:#fff; min-height:300px; display:flex; align-items:center; justify-content:center; }
    .table-migration { width:100%; border-collapse:separate; border-spacing:0 8px; }
    .table-migration td { padding:12px; border-bottom:1px solid #f0f0f0; background:#fff; }
    .segment-pill { padding:4px 10px; border-radius:6px; font-weight:600; font-size:0.8rem; display:inline-block; min-width:80px; text-align:center; }
    .guest-card { background:#fff; border:1px solid #e0e0e0; border-radius:12px; padding:20px; height:100%; transition:transform 0.2s; }
    .guest-card:hover { transform:translateY(-4px); box-shadow:0 10px 15px rgba(0,0,0,0.05); }
    .timeline { border-left:2px solid #e9ecef; margin-left:10px; padding-left:20px; margin-top:15px; }
    .timeline-item { position:relative; margin-bottom:15px; }
    .timeline-item::before { content:''; position:absolute; left:-26px; top:4px; width:10px; height:10px; border-radius:50%; background:#fff; border:2px solid #ccc; }
    .timeline-item.growth::before { border-color:#28a745; background:#28a745; }
    .timeline-item.churn::before { border-color:#dc3545; background:#dc3545; }
    .kpi-box { padding:20px; border-radius:10px; text-align:center; height:100%; }
    .kpi-val { font-size:2rem; font-weight:800; line-height:1.2; }
    .kpi-label { text-transform:uppercase; font-size:0.7rem; letter-spacing:1px; margin-bottom:8px; }

    .flow-table { width:100%; border-collapse:collapse; }
    .flow-table th { background:#f8f9fa; padding:10px 14px; text-align:left; font-size:11px; color:#666; text-transform:uppercase; border-bottom:2px solid #eee; }
    .flow-table td { padding:10px 14px; font-size:0.82rem; border-bottom:1px solid #f0f0f0; }
    .flow-arrow { color:#28a745; font-weight:700; }
    .flow-arrow.down { color:#dc3545; }
</style>
{% endblock %}

{% block content %}
<div class="migration-wrapper">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 fw-bold mb-1">üì¶ –ò—Å—Ç–æ—Ä–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏ ‚Äî –î–æ—Å—Ç–∞–≤–∫–∞</h1>
            <p class="text-muted mb-0">–§–∏–ª–∏–∞–ª: {{ branch.name }}</p>
        </div>
        <form method="GET" class="d-flex gap-3 bg-white p-2 rounded border shadow-sm">
            <select name="days" class="form-select border-0 bg-light fw-bold" style="width:160px;">
                <option value="7" {% if days == 7 %}selected{% endif %}>7 –¥–Ω–µ–π</option>
                <option value="14" {% if days == 14 %}selected{% endif %}>14 –¥–Ω–µ–π</option>
                <option value="30" {% if days == 30 %}selected{% endif %}>30 –¥–Ω–µ–π</option>
                <option value="90" {% if days == 90 %}selected{% endif %}>90 –¥–Ω–µ–π</option>
            </select>
            <select name="segment" class="form-select border-0 bg-light fw-bold" style="width:200px;">
                <option value="">–í—Å–µ —Å–µ–≥–º–µ–Ω—Ç—ã</option>
                {% for seg in all_segments %}
                <option value="{{ seg.code }}" {% if selected_segment == seg.code %}selected{% endif %}>{{ seg.emoji }} {{ seg.name }}</option>
                {% endfor %}
            </select>
            <button type="submit" class="btn btn-dark rounded px-3">–û–±–Ω–æ–≤–∏—Ç—å</button>
        </form>
    </div>

    <div class="mode-tabs">
        <a href="{% url 'rf-migration-statistics' id=branch.id %}" class="mode-tab">
            –ö–ê–§–ï<small>–ò—Å—Ç–æ—Ä–∏—è –º–∏–≥—Ä–∞—Ü–∏–π</small>
        </a>
        <a href="{% url 'delivery-rf-migration' id=branch.id %}" class="mode-tab active">
            –î–û–°–¢–ê–í–ö–ê<small>–ò—Å—Ç–æ—Ä–∏—è –º–∏–≥—Ä–∞—Ü–∏–π</small>
        </a>
    </div>

    <div class="content-card">
        <h5 class="fw-bold mb-4">–ü–æ—Ç–æ–∫–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤ –¥–æ—Å—Ç–∞–≤–∫–∏</h5>
        <div id="sankey_chart" class="sankey-area">
            <div class="spinner-border text-secondary" role="status"></div>
        </div>
    </div>

    <div class="content-card">
        <h5 class="fw-bold mb-4">–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∑–∞ –ø–µ—Ä–∏–æ–¥</h5>
        <div class="row g-3">
            <div class="col-md">
                <div class="kpi-box" style="background:#f0fff4;color:#166534;">
                    <div class="kpi-label">–†–æ—Å—Ç –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏</div>
                    <div class="kpi-val">+{{ growth_count }}</div>
                </div>
            </div>
            <div class="col-md">
                <div class="kpi-box" style="background:#fff7ed;color:#9a3412;">
                    <div class="kpi-label">–û—Å—Ç—ã–≤–∞–Ω–∏–µ</div>
                    <div class="kpi-val">{{ natural_cooling_count }}</div>
                </div>
            </div>
            <div class="col-md">
                <div class="kpi-box" style="background:#fef2f2;color:#991b1b;">
                    <div class="kpi-label">–û—Ç—Ç–æ–∫ –≤ R0</div>
                    <div class="kpi-val">{{ real_churn_count }}</div>
                </div>
            </div>
            <div class="col-md">
                <div class="kpi-box" style="background:#eff6ff;color:#1e40af;">
                    <div class="kpi-label">–†–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è</div>
                    <div class="kpi-val">{{ reactivation_count }}</div>
                </div>
            </div>
        </div>
    </div>

    {% if flow_stats %}
    <div class="content-card">
        <h5 class="fw-bold mb-4">–î–µ—Ç–∞–ª—å–Ω—ã–µ –ø–æ—Ç–æ–∫–∏</h5>
        <table class="flow-table">
            <thead><tr><th>–û—Ç–∫—É–¥–∞</th><th></th><th>–ö—É–¥–∞</th><th class="text-end">–ö–ª–∏–µ–Ω—Ç–æ–≤</th></tr></thead>
            <tbody>
                {% for flow in flow_stats %}
                <tr>
                    <td><span class="segment-pill" style="background:#f8f9fa;border:1px solid #ddd;">{{ flow.from_segment }}</span></td>
                    <td class="text-center {% if flow.direction == 'up' %}flow-arrow{% else %}flow-arrow down{% endif %}">
                        {% if flow.direction == 'up' %}‚Üë{% else %}‚Üì{% endif %}
                    </td>
                    <td><span class="segment-pill" style="background:#f8f9fa;border:1px solid #ddd;">{{ flow.to_segment }}</span></td>
                    <td class="text-end fw-bold">{{ flow.count }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    {% if recent_guests %}
    <div class="content-card">
        <h5 class="fw-bold mb-4">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤ –¥–æ—Å—Ç–∞–≤–∫–∏</h5>
        <div class="row g-3">
            {% for guest in recent_guests|slice:":6" %}
            <div class="col-md-4">
                <div class="guest-card">
                    <div class="d-flex align-items-center gap-2 mb-2">
                        <div>
                            <div class="fw-bold small">{{ guest.name }}</div>
                            <div class="text-muted" style="font-size:11px;">
                                <span class="segment-pill" style="background:#f0f0f0;">{{ guest.from_segment }}</span>
                                ‚Üí <span class="segment-pill" style="background:#e8f5e9;">{{ guest.to_segment }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="timeline">
                        {% for event in guest.history %}
                        <div class="timeline-item {% if event.is_growth %}growth{% else %}churn{% endif %}">
                            <div style="font-size:11px;color:#666;">{{ event.date }}</div>
                            <div style="font-size:12px;font-weight:600;">{{ event.segment }}</div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript">
    google.charts.load('current', {'packages':['sankey']});
    google.charts.setOnLoadCallback(drawChart);

    function drawChart() {
        const container = document.getElementById('sankey_chart');
        const rawData = {{ sankey_data|safe }};
        if (!rawData || rawData.length === 0) {
            container.innerHTML = '<div class="text-center text-muted py-5">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –¥–∏–∞–≥—Ä–∞–º–º—ã –∑–∞ —ç—Ç–æ—Ç –ø–µ—Ä–∏–æ–¥</div>';
            return;
        }
        var data = new google.visualization.DataTable();
        data.addColumn('string', 'From');
        data.addColumn('string', 'To');
        data.addColumn('number', 'Guests');
        data.addRows(rawData);
        var options = {
            width: '100%', height: 300,
            sankey: {
                node: { label: { fontName:'Inter', fontSize:12, bold:true, color:'#333' }, nodePadding:20, width:12 },
                link: { colorMode:'gradient', fillOpacity:0.2 }
            }
        };
        var chart = new google.visualization.Sankey(container);
        chart.draw(data, options);
    }
</script>
{% endblock %}
